package se.tink.backend.aggregation.agents.nxgen.fi.banks.op.utils;

import java.math.BigInteger;
import org.junit.Assert;
import org.junit.Test;
import se.tink.backend.aggregation.agents.nxgen.fi.banks.op.utils.srp.ClientEvidenceMessageResponse;
import se.tink.backend.aggregation.agents.utils.encoding.EncodingUtils;

public class ActivationUtilsTest {
    // https://integration-proxy.global-production.tink.network/analyze?query=filename%3A%22fi_op%20bank_28.0.1_reg_login_full_hashlogs%22%20AND%20operation%3A%22srp_exchange%22
    private static final String SRP_SESSION_KEY_AS_HEX =
            "104fab0a277b8a2c098f0e30920a4f2a564a1d40647845c662578b957d50adb10d48361d846c84f99d7bd6a26d0e2212b295dce37a11c5ca9baf3a8d7c326009458c4f4482218756cdd06e3d15bbee613695f8ff5fbecb0a6a2c735ecaee1a7708c672a1c8d1068e32ceee0466b3bb90a715e20e1dc5969fd6f61503e6e70d06b409b998ab429d06da6122071d8c1549c8bddc8390ea45b84f2975ae28d93817caede13cf39ac9fa6c01a83655b884b1e266b21d5d8fbad35bb65e0a8690cc020779034d2c95113e529584514cfa9a51e8376a997f8a7ae3e0ee709a1932d881bbc440342b62714066946441ef492a9ad3622e67b332cf15f893497064ed0603";

    @Test
    public void testDecryptActivationMessage1() {
        String encryptedData =
                "AF3B550A55F237E685ECEFCB69BDC275024D4EA01C8B9450D4843DF2B9E839E09390DA54CFD88739A95699E4DB6E6C393CC342037084B8539D217BC67DFF490C0D145987DB07A65BF268E5B9F0F2A44E43B4E4C52C3483DC313126781B7671C8666446BF007AEB85D4B6F50A";
        String encryptionCounter = "0555A77777FA179C";

        ClientEvidenceMessageResponse dummyClientEvidenceMessageResponse =
                new ClientEvidenceMessageResponse(
                        null,
                        null,
                        new BigInteger(EncodingUtils.decodeHexString(SRP_SESSION_KEY_AS_HEX)));

        byte[] decryptedData =
                ActivationUtils.decryptActivationData(
                        dummyClientEvidenceMessageResponse, encryptedData, encryptionCounter);

        String expectedDecryptedData =
                "303030303546444634374141364230303030303030303030303030303030303034443031463242443437313236304334323031413731323642414446363237323637383644384642343945324438324436434230353145353732303838303335363431414346423644413539";

        Assert.assertEquals(
                "Decrypted activationMessage1 was not correct.",
                expectedDecryptedData,
                EncodingUtils.encodeHexAsString(decryptedData));
    }

    @Test
    public void testDecryptStaticVector() {
        String encryptedData =
                "9616422BD199DF3860632CA75706A0EF7EF930AB579DB9366931A64BC619190507D6495E3922DA91E6DBE82AB4ED2807DD6F3020FE0053207390FF9C71CFB9111D9074BDC9EEAB2BEB4C17B28479965CD196FA5A96ED783D583C3B97E8EF79A199E8670758B927CD5EC53040A184FE2F58FACBCADE1923C72ECA65DBAA48929CA338EF6037AA7448EA088F21DE676B89CE04946201EADB2EDCF624F7E4F35BFFD0A3C109F1F906E910E44661E559A44367D7A52E17D054B2FD6A163C43B53C8253A266BADE02368B1911E3172BA6D6092E889C7C2218198E81451C5D3E1F7E415AB7873EEAA94C65E97BF679E988563676017FBA8E65C2D6C8CE46F963BA228EFFE7920D8F9258420072A1F07749D5E1235067778A01E2CE751D8F9492044475274703EF8E2BD19AA1B729286D41F7244A840C6F1339EB0C6EA5234372A23F093C46B218CBEEEF8E77028D13F7D0A3215970B537EF2267E3E61471F6B17E77A631D190B10A7A69CEB99DB5E798074377540C0FC45DBC2CCDA96CDC87A7756E161A268991EDE029679D78FBB416343845DC9371ECA61F247150008F2B9D035E42F8F8561640C69EC5AE601C01BF96CECAF2CA025C540D05081FECAE6EC6B9DD8BC32DEF00A3BF99B86C2DFFCC7472B25D1F48534EE350B4DB91E61926EADAEBC0C6AE9667B64EC2975398A0E10206107CFD3372C7FA0610CD1C7F8CDA74B3B91714D3B22B0F6562657142EDE320A252101B8E612278FEC6257CEC98EFE69BD340A3CA52BD2E37F2ADD3AC071051E95DFC0331D764169BBEB1D6095BF2C39CF13104EAFEFBEE3A69C90EE029B58971191EE4D6E78474B2F6004CBA55CB68CC0E8368DAA4AAFAED9A4975106C37603710F4F515EDED2836FAB49FB65A3A9A76B2CF55B0A70AE1DAE1FE9D21E59043BAED702285713FE5D1826BB676851322EBB731615376C6098984E5DB59D617FE24DEE418975058AD7CD95E76B707069420CC7B21407BE21D9EA0E89A3D64F9F6BED45840F38DAFF10BEB62F26924DCB5C085D109FC736BBBC38210236116C288CF26E59DCC0016CA4DE48F7F18DA1865582EA8BEDDA06CE8BED3E20CC9F2C72A95EB9C16AA4CE7AF8FD84EA8BB534F90F63981D847659DF221425AD6109B4A3B58226B14829E3F88F6AF5ADB2871252C7870357E4FC4A5FF3D1CAF13E9B1C5344690C97832D54C48521B2F2AB625C6C1542F031FBEA4B5C9E14D421D79619E19064CD829A64CB5D86917DC55144475831AD45E17D93DE8049D258B70665F564072E6CA6D38B552B02037F4E748E466E8E619EC6707F56A3E312D20D6B0C225F24A32F9FBF4D1B1AF963047E043F7C42AA0A1F88F86866B183462A50EB502DFC6FDD3112254458426509AEC3022B023DFDE7BDB797F9CECA94EDECE5E79C97E982161D474D94D5114B1A80D321919DA165D398B6F813750E83E719B1AF1DFC88525504014FC8A8B4D91A6CDFC5A67326A4D4F6D165200EB7C357B526F58BEADF10F528BCF5BB1FB1F061D9D9ECA82D6EDBF91BF1327CF4549F30153F194A2B66EE2EF09C94944BDD32DDF01708FA0006733F80613D9FFD74BF181C24FA2EF4B63F033D78543CA4E6DBBF74D99356C259D0C13E9FF20FE2E0694DF8A60B98D842E065F34A56967C98263E08135FDA3740812C3A4E636115FD779A7BB8FE1E207B43D8BA091CF0C64046656ADCC8465D82606BFC77973065ED44780FDB0B2F2AFEF1377281E3C44009AAB32F739FFC30AE9558C58F81B4ED71F00AFD38334CA7A803F9585602DC2DC39AC1ED87164B29A9DFA5E34089C9FA2663FB2A677759FDAF10565011BAD2AB114D37147D06BB51AAEA557B848F93334DC788125A00A40DEE285C09403C2A6CC19D673C197468F7ADA3404369079D9FA76A0B7940E73C3CDCEE9A89C83C1";
        String encryptionCounter = "220FB489CA3C6ABD";

        ClientEvidenceMessageResponse dummyClientEvidenceMessageResponse =
                new ClientEvidenceMessageResponse(
                        null,
                        null,
                        new BigInteger(EncodingUtils.decodeHexString(SRP_SESSION_KEY_AS_HEX)));

        byte[] decryptedData =
                ActivationUtils.decryptActivationData(
                        dummyClientEvidenceMessageResponse, encryptedData, encryptionCounter);

        String expectedDecryptedData =
                "333830383032413530313033343634343445303231304641463134393542463931333141303144353630313431463041453439333443303330313031303430313034303530313130303630313031303730313031303830313035303930313034304130313031304230313030304330313031304530313031304630313031313030313031333830313033334330313031343630313036343730313030313134373132303130303133303130313134303130313135304335333433354634463445344334393445343532303230323031363031303131373034303138333134443031383031303431393031313031413031313031423031313031433031313032313031313032323031313032333031313032343031313032393031313032413031303032423031303032433031303231313437313230313030313330313031313430313032313530433533343335463446343634363443343934453435323032303136303130313137303430313833313444303138303130343139303131303141303131303142303131303143303131303231303131303232303131303233303131303234303131303239303130363241303130303242303130303243303130323131324631323031303031333031303131343031303331353043353234463546344634453443343934453435323032303230313630313031313730343030383044303030313830313030323930313130324130313030324230313030324330313032313132463132303130303133303130313134303130343135304335323446354634463436343634433439344534353230323031363031303131373034303038304430303331383031303032393031303632413031303032423031303032433031303231313335313230313030313330313031313430313035313530433433353235463446344534433439344534353230323032303136303130313137303430313833443444303138303130313139303130343231303130343239303131303241303130303242303130303243303130323131333531323031303031333031303131343031303631353043343335323546344634363436344334393445343532303230313630313031313730343031383344344433313830313031313930313034323130313034323930313036324130313030324230313030324330313032313135463132303130303133303130313134303130373135304335333437354634463445344334393445343532303230323031363031303131373034303144444434443031383031303831393031303031413031303031423031303031433031303031443031303031453031303031463031303032303031303032313031313032323031313032333031313032343031313032353031313032363031313032373031313032383031313032393031313032413031303032423031303032433031303231313546313230313030313330313031313430313038313530433533343735463446343634363443343934453435323032303136303130313137303430314444443444333138303130383139303130303141303130303142303130303143303130303144303130303145303130303146303130303230303130303231303130383232303130383233303130383234303130383235303130383236303130383237303130383238303130383239303130363241303130303242303130303243303130323344333531323031303031333031303131343031303131353043343134333534353632303230323032303230323032303230313630313031313730343031383331344430313830313031313930313130323130313130323930313035324130313030324230313030324330313032";

        Assert.assertEquals(
                "Decrypted staticVector was not correct.",
                expectedDecryptedData,
                EncodingUtils.encodeHexAsString(decryptedData));
    }
}
