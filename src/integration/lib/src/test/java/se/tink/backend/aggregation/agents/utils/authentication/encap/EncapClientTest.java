package se.tink.backend.aggregation.agents.utils.authentication.encap;

import com.google.common.collect.Maps;
import java.util.List;
import java.util.Map;
import org.junit.Assert;
import org.junit.Test;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.ActivationResultEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.AuthenticationResultEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.PluginEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.RegistrationEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.SamlResultEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.entities.SigningEntity;
import se.tink.backend.aggregation.agents.utils.authentication.encap.rpc.ActivationResponse;
import se.tink.backend.aggregation.agents.utils.authentication.encap.rpc.AuthenticationResponse;
import se.tink.backend.aggregation.agents.utils.authentication.encap.rpc.SamlResponse;
import static org.hamcrest.core.IsNull.notNullValue;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertThat;

public class EncapClientTest {

    @Test
    public void testActivationResponseParsing() {
        final String activationResponseString = ")]}'{  \"code\": 0,  \"outdated\": false,  \"result\": {    \"signingKeyPhrase\": \"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1\",    \"registration\": {   \"registrationId\": \"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX2\",   \"pinCodeLength\": 4,      \"pinCodeType\": 1,     \"otpLength\": 6,      \"allowedAuthMethods\": [        \"DEVICE:STRONG_TOUCH_ID\",        \"DEVICE:PIN\",   \"DEVICE:ANDROID_FINGERPRINT\",        \"DEVICE\"      ]    },    \"b64OtpChallenge\": \"REMG12gmIH+MhtGX7igILw==\",    \"b64ClientSaltNextKey\":\"REMG23gmIH+MhtGX7igILw==\",\"clientSaltNextKeyId\": -1234567890,    \"plugin\": {      \"signing\": {        \"csr\": {}      }    }  }}";

        ActivationResponse registrationResponse = EncapUtils.parseActivationResponse(activationResponseString);

        assertThat(registrationResponse, notNullValue());
        assertEquals(registrationResponse.getCode(), 0);
        assertEquals(registrationResponse.isOutdated(), false);

        ActivationResultEntity resultEntity = registrationResponse.getResult();
        assertThat(resultEntity, notNullValue());
        assertEquals(resultEntity.getSigningKeyPhrase(), "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1");
        assertEquals(resultEntity.getB64OtpChallenge(), "REMG12gmIH+MhtGX7igILw==");
        assertEquals(resultEntity.getB64ClientSaltNextKey(), "REMG23gmIH+MhtGX7igILw==");
        assertEquals(resultEntity.getClientSaltNextKeyId(), -1234567890);

        RegistrationEntity registrationEntity = resultEntity.getRegistration();
        assertThat(registrationEntity, notNullValue());
        assertEquals(registrationEntity.getRegistrationId(), "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX2");
        assertEquals(registrationEntity.getPinCodeLength(), 4);
        assertEquals(registrationEntity.getPinCodeType(), 1);
        assertEquals(registrationEntity.getOtpLength(), 6);
        assertEquals(registrationEntity.getAllowedAuthMethods().get(0), "DEVICE:STRONG_TOUCH_ID");

        PluginEntity pluginEntity = resultEntity.getPlugin();
        assertThat(pluginEntity, notNullValue());

        SigningEntity signingEntity = pluginEntity.getSigning();
        assertThat(signingEntity, notNullValue());
    }

    @Test
    public void testAuthenticationResponseParsing() {
        final String authenticationResponseString = ")]}'{  \"code\": 0,  \"outdated\": false,  \"result\": {    \"clientSaltCurrentKeyId\": -1234567890,    \"b64ClientSaltCurrentKey\": \"REMG23gmIH+MhtGX7igILw==\", \"purpose\": 1,   \"totalAttempts\": 3,    \"remainingAttempts\":3,    \"authenticationWithoutPin\": true,    \"allowedAuthMethods\": [      \"DEVICE:PIN\",      \"DEVICE\"    ],   \"b64OtpChallenge\": \"XYZdSs3JqTvpNBSX+9w71Q==\",    \"b64ClientSaltNextKey\": \"REMG34gmIH+MhtGX7igILw==\",    \"clientSaltNextKeyId\": -1234567891,    \"plugin\": {}  }}";

        AuthenticationResponse authenticationResponse = EncapUtils.parseAuthenticationResponse(authenticationResponseString);

        assertThat(authenticationResponse, notNullValue());
        assertEquals(authenticationResponse.getCode(), 0);
        assertEquals(authenticationResponse.isOutdated(), false);

        AuthenticationResultEntity resultEntity = authenticationResponse.getResult();
        assertThat(resultEntity, notNullValue());
        assertEquals(resultEntity.getClientSaltCurrentKeyId(), -1234567890);
        assertEquals(resultEntity.getB64ClientSaltCurrentKey(), "REMG23gmIH+MhtGX7igILw==");
        assertEquals(resultEntity.getPurpose(), 1);
        assertEquals(resultEntity.getTotalAttempts(), 3);
        assertEquals(resultEntity.getRemainingAttempts(), 3);
        assertEquals(resultEntity.getAuthenticationWithoutPin(), true);
        assertEquals(resultEntity.getAllowedAuthMethods().get(0), "DEVICE:PIN");
        assertEquals(resultEntity.getAllowedAuthMethods().get(1), "DEVICE");
        assertEquals(resultEntity.getB64OtpChallenge(), "XYZdSs3JqTvpNBSX+9w71Q==");
        assertEquals(resultEntity.getB64ClientSaltNextKey(), "REMG34gmIH+MhtGX7igILw==");
        assertEquals(resultEntity.getClientSaltNextKeyId(), -1234567891);

        PluginEntity pluginEntity = resultEntity.getPlugin();
        assertThat(pluginEntity, notNullValue());
    }

    @Test
    public void testSamlResponseParsing() {
        final String samlResponseString = ")]}'{  \"code\": 0,  \"outdated\": false,  \"result\": {    \"responseType\": 3,  \"responseContent\": \"<saml1p:Response xmlns:saml1p=\\\"urn:oasis:names:tc:SAML:1.0:protocol\\\" xmlns:xs=\\\"http://www.w3.org/2001/XMLSchema\\\" IssueInstant=\\\"2018-01-19T15:15:50.846Z\\\" MajorVersion=\\\"1\\\" MinorVersion=\\\"1\\\" ResponseID=\\\"_7a56e346d972be6bd5856ccb4abd9d69\\\"><ds:Signature xmlns:ds=\\\"http://www.w3.org/2000/09/xmldsig#\\\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\\\"http://www.w3.org/2001/10/xml-exc-c14n#\\\"/><ds:SignatureMethod Algorithm=\\\"http://www.w3.org/2000/09/xmldsig#dsa-sha1\\\"/><ds:Reference URI=\\\"#_7a56e346d972be6bd5856ccb4abd9d69\\\"><ds:Transforms><ds:Transform Algorithm=\\\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\\\"/><ds:Transform Algorithm=\\\"http://www.w3.org/2001/10/xml-exc-c14n#\\\"><ec:InclusiveNamespacesxmlns:ec=\\\"http://www.w3.org/2001/10/xml-exc-c14n#\\\" PrefixList=\\\"xs\\\"/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\\\"http://www.w3.org/2001/04/xmlenc#sha256\\\"/><ds:DigestValue>MbbeA12WYeVGyeXxN9xaJi09+dnWdHfSPgbNOq0hh/E=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Wo+E1UTNBNWIdk/DV/8x6UEyLX+N/f5AY+0vJFS8pIRiXnhuUn+MUA==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml1p:Status><saml1p:StatusCode Value=\\\"saml1p:Success\\\"/></saml1p:Status><saml1:Assertion xmlns:saml1=\\\"urn:oasis:names:tc:SAML:1.0:assertion\\\" AssertionID=\\\"_5919a0b81e8fca63bca8ec4eca3c2ca4\\\"IssueInstant=\\\"2018-01-19T15:15:50.846Z\\\" Issuer=\\\"encap\\\" MajorVersion=\\\"1\\\" MinorVersion=\\\"1\\\"><saml1:Conditions NotBefore=\\\"2018-01-19T15:15:50.846Z\\\" NotOnOrAfter=\\\"2018-01-19T15:16:50.846Z\\\"><saml1:DoNotCacheCondition/></saml1:Conditions><saml1:AttributeStatement><saml1:Subject><saml1:NameIdentifier Format=\\\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\\\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject><saml1:AttributeAttributeName=\\\"SmartDevice.AttributesHash\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">uNGrfDHYdyPwADLebSqABdKhpBPKoJw5PlnN1Azzmik=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.UserAgent\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">Mozilla/5.0 (iPhone;CPU iPhone OS 10_2 like Mac OS X) AppleWebKit/602.3.12 (KHTML, like Gecko) Mobile/14C92</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.AuthenticationLevel\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">TWO_FACTOR</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.SessionId\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">1927793404</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.UserId\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.Date\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">1516374950846</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.DeviceModel\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">iPhone8,1</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.RegistrationId\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.ApplicationHash\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.Status\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">SUCCESS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.IsRootAvailable\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">true</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.OperatingSystemType\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">iOS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.PlatformId\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.DeviceHash\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">VSKIZeZiu46kYGWe/5pEXLdfIeaumvYXvb4c7Mh7cII=</saml1:AttributeValue></saml1:Attribute><saml1:AttributeAttributeName=\\\"SmartDevice.OperatingSystemVersion\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">10.2</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"SmartDevice.DeviceManufacturer\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">Apple</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.AuthMethods\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\"xsi:type=\\\"xs:string\\\">DEVICE:PIN,DEVICE</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.DeviceId\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\\\"encap.PushSent\\\" AttributeNamespace=\\\"urn:no:encap:server\\\"><saml1:AttributeValue xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:type=\\\"xs:string\\\">false</saml1:AttributeValue></saml1:Attribute></saml1:AttributeStatement><saml1:AuthenticationStatement samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhq346564rtetwkjheq==\\\"2018-01-19T15:15:50.846Z\\\" AuthenticationMethod=\\\"SmartDevice\\\"><saml1:Subject><saml1:NameIdentifier Format=\\\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\\\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject></saml1:AuthenticationStatement></saml1:Assertion></saml1p:Response>\",    \"plugin\":{}  }}";
        final String expectedResponseContent = "<saml1p:Response xmlns:saml1p=\"urn:oasis:names:tc:SAML:1.0:protocol\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" IssueInstant=\"2018-01-19T15:15:50.846Z\" MajorVersion=\"1\" MinorVersion=\"1\" ResponseID=\"_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/><ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#dsa-sha1\"/><ds:Reference URI=\"#_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespacesxmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"xs\"/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/><ds:DigestValue>MbbeA12WYeVGyeXxN9xaJi09+dnWdHfSPgbNOq0hh/E=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Wo+E1UTNBNWIdk/DV/8x6UEyLX+N/f5AY+0vJFS8pIRiXnhuUn+MUA==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml1p:Status><saml1p:StatusCode Value=\"saml1p:Success\"/></saml1p:Status><saml1:Assertion xmlns:saml1=\"urn:oasis:names:tc:SAML:1.0:assertion\" AssertionID=\"_5919a0b81e8fca63bca8ec4eca3c2ca4\"IssueInstant=\"2018-01-19T15:15:50.846Z\" Issuer=\"encap\" MajorVersion=\"1\" MinorVersion=\"1\"><saml1:Conditions NotBefore=\"2018-01-19T15:15:50.846Z\" NotOnOrAfter=\"2018-01-19T15:16:50.846Z\"><saml1:DoNotCacheCondition/></saml1:Conditions><saml1:AttributeStatement><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject><saml1:AttributeAttributeName=\"SmartDevice.AttributesHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">uNGrfDHYdyPwADLebSqABdKhpBPKoJw5PlnN1Azzmik=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.UserAgent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Mozilla/5.0 (iPhone;CPU iPhone OS 10_2 like Mac OS X) AppleWebKit/602.3.12 (KHTML, like Gecko) Mobile/14C92</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthenticationLevel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">TWO_FACTOR</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.SessionId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1927793404</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.UserId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Date\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1516374950846</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceModel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iPhone8,1</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.RegistrationId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.ApplicationHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Status\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SUCCESS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.IsRootAvailable\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">true</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.OperatingSystemType\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iOS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PlatformId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">VSKIZeZiu46kYGWe/5pEXLdfIeaumvYXvb4c7Mh7cII=</saml1:AttributeValue></saml1:Attribute><saml1:AttributeAttributeName=\"SmartDevice.OperatingSystemVersion\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">10.2</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceManufacturer\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Apple</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthMethods\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"xsi:type=\"xs:string\">DEVICE:PIN,DEVICE</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.DeviceId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PushSent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">false</saml1:AttributeValue></saml1:Attribute></saml1:AttributeStatement><saml1:AuthenticationStatement samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhq346564rtetwkjheq==\"2018-01-19T15:15:50.846Z\" AuthenticationMethod=\"SmartDevice\"><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject></saml1:AuthenticationStatement></saml1:Assertion></saml1p:Response>";
        SamlResponse samlResponse = EncapUtils.parseSamlResponse(samlResponseString);
        assertThat(samlResponse, notNullValue());
        assertEquals(samlResponse.getCode(), 0);
        assertEquals(samlResponse.isOutdated(), false);

        SamlResultEntity resultEntity = samlResponse.getResult();
        assertThat(resultEntity, notNullValue());
        assertEquals(resultEntity.getResponseType(), 3);
        assertEquals(resultEntity.getResponseContent(), expectedResponseContent);

        PluginEntity pluginEntity = resultEntity.getPlugin();
        assertThat(pluginEntity, notNullValue());
    }

    @Test
    public void testApplicationHashBuild() {
        final String expectedApplicationHash = "BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=";
        final String appId = "com.aktia.mobilebank";
        String applicationHash = EncapUtils.buildApplicationHashAsB64String(appId);
        assertEquals(applicationHash, expectedApplicationHash);
    }

    @Test
    public void testBuildFirstMessageForActivation() {
        final String expectedMessage = "applicationId=encap&device.ApplicationHash=BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk%3D&device.DeviceHash=VSKIZeZiu46kYGWe%2F5pEXLdfIeaumvYXvb4c7Mh7cII%3D&device.DeviceManufacturer=Apple&device.DeviceModel=iPhone8%2C1&device.DeviceName=Tink&device.DeviceUUID=8AFA762F-ADA2-41C7-93A5-06E605F54D2C&device.IsRootAvailable=false&device.OperatingSystemName=iOS&device.OperatingSystemType=iOS&device.SignerHashes=&device.SystemVersion=10.2&device.UserInterfaceIdiom=0&hexAPNToken=&meta.applicationVersion=108&meta.encapAPIVersion=3.3.6&operation=REGISTER&response.requireToken=true";
        Map<String, String> storage = setupEncapStorageForTest();
        String message = EncryptedMessageService.buildFirstMessageForActivation(storage);
        assertEquals(expectedMessage, message);
    }

    @Test
    public void testBuildFirstMessageForAuthentication() {
        final String expectedMessage = "applicationId=encap&clientOnly=true&clientSaltCurrentKeyId=-1256450962&device.ApplicationHash=BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk%3D&device.DeviceHash=VSKIZeZiu46kYGWe%2F5pEXLdfIeaumvYXvb4c7Mh7cII%3D&device.DeviceManufacturer=Apple&device.DeviceModel=iPhone8%2C1&device.DeviceName=Tink&device.DeviceUUID=8AFA762F-ADA2-41C7-93A5-06E605F54D2C&device.IsRootAvailable=false&device.OperatingSystemName=iOS&device.OperatingSystemType=iOS&device.SignerHashes=&device.SystemVersion=10.2&device.UserInterfaceIdiom=0&meta.applicationVersion=108&meta.encapAPIVersion=3.3.6&operation=IDENTIFY&purpose=1&registrationId=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1&response.requireToken=true";
        Map<String, String> storage = setupEncapStorageForTest();
        String message = EncryptedMessageService.buildFirstMessageForAuthentication(storage);
        assertEquals(expectedMessage, message);
    }

    @Test
    public void testBuildSecondMessageForActivation() {
        final String expectedMessage = "activatedAuthMethods=DEVICE&activatedAuthMethods=DEVICE%3APIN&applicationId=encap&b64AuthenticationKey=dfgdfgsdflh3453645fgRBC%2B4w3K5k%3D&b64AuthenticationKeyWithoutPin=fdjlbkjhlk45j6lkrgjsdlvhhlshdfMBMXQgHTLRw%3D&b64ChallengeResponse=dfhGHGMHJFDVdFDfessDJLwcAIw%3D%3D&b64ChallengeResponseWithoutPin=r9%2FDHTYefcdflDFSGzwyJwEg%3D%3D&b64TotpKey=mWtO8WgKsODjLQK6QQaBf7MQDEgfheRH4yJZioIYd3Q%3D&device.ApplicationHash=BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk%3D&device.DeviceHash=VSKIZeZiu46kYGWe%2F5pEXLdfIeaumvYXvb4c7Mh7cII%3D&device.DeviceManufacturer=Apple&device.DeviceModel=iPhone8%2C1&device.DeviceName=Tink&device.DeviceUUID=8AFA762F-ADA2-41C7-93A5-06E605F54D2C&device.IsRootAvailable=false&device.OperatingSystemName=iOS&device.OperatingSystemType=iOS&device.SignerHashes=&device.SystemVersion=10.2&device.UserInterfaceIdiom=0&meta.applicationVersion=108&meta.encapAPIVersion=3.3.6&operation=ACTIVATE&registrationId=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1&saltHash=dflkfdnbFGFHghfgvldajncv45eCBEttHMQ%3D";
        Map<String, String> storage = setupEncapStorageForTest();
        String message = EncryptedMessageService.buildSecondMessageForActivation(storage);
        assertEquals(expectedMessage, message);
    }

    @Test
    public void testBuildSecondMessageForAuthentication() {
        final String expectedMessage = "applicationId=encap&b64ResponseCurrent=Ft3pIosdfGFHgfFdssaTQavw%3D%3D&device.ApplicationHash=BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk%3D&device.DeviceHash=VSKIZeZiu46kYGWe%2F5pEXLdfIeaumvYXvb4c7Mh7cII%3D&device.DeviceManufacturer=Apple&device.DeviceModel=iPhone8%2C1&device.DeviceName=Tink&device.DeviceUUID=8AFA762F-ADA2-41C7-93A5-06E605F54D2C&device.IsRootAvailable=false&device.OperatingSystemName=iOS&device.OperatingSystemType=iOS&device.SignerHashes=&device.SystemVersion=10.2&device.UserInterfaceIdiom=0&hexAPNToken=&meta.applicationVersion=108&meta.encapAPIVersion=3.3.6&operation=AUTHENTICATE&registrationId=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1&saltHash1=dflkfdnbFGFHghfgvldajncv45eCBEttHMQ%3D&usedAuthMethod=DEVICE%3APIN";
        Map<String, String> storage = setupEncapStorageForTest();
        String message = EncryptedMessageService.buildSecondMessageForAuthentication(storage);
        assertEquals(expectedMessage, message);
    }

    @Test
    public void testsamlObjectParsing() {
        String responseContentStringOneEqualChar = "<saml1p:Response xmlns:saml1p=\"urn:oasis:names:tc:SAML:1.0:protocol\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" IssueInstant=\"2018-01-19T15:15:50.846Z\" MajorVersion=\"1\" MinorVersion=\"1\" ResponseID=\"_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/><ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#dsa-sha1\"/><ds:Reference URI=\"#_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespacesxmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"xs\"/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/><ds:DigestValue>MbbeA12WYeVGyeXxN9xaJi09+dnWdHfSPgbNOq0hh/E=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Wo+E1UTNBNWIdk/DV/8x6UEyLX+N/f5AY+0vJFS8pIRiXnhuUn+MUA==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml1p:Status><saml1p:StatusCode Value=\"saml1p:Success\"/></saml1p:Status><saml1:Assertion xmlns:saml1=\"urn:oasis:names:tc:SAML:1.0:assertion\" AssertionID=\"_5919a0b81e8fca63bca8ec4eca3c2ca4\"IssueInstant=\"2018-01-19T15:15:50.846Z\" Issuer=\"encap\" MajorVersion=\"1\" MinorVersion=\"1\"><saml1:Conditions NotBefore=\"2018-01-19T15:15:50.846Z\" NotOnOrAfter=\"2018-01-19T15:16:50.846Z\"><saml1:DoNotCacheCondition/></saml1:Conditions><saml1:AttributeStatement><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject><saml1:AttributeAttributeName=\"SmartDevice.AttributesHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">uNGrfDHYdyPwADLebSqABdKhpBPKoJw5PlnN1Azzmik=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.UserAgent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Mozilla/5.0 (iPhone;CPU iPhone OS 10_2 like Mac OS X) AppleWebKit/602.3.12 (KHTML, like Gecko) Mobile/14C92</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthenticationLevel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">TWO_FACTOR</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.SessionId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1927793404</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.UserId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Date\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1516374950846</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceModel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iPhone8,1</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.RegistrationId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.ApplicationHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Status\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SUCCESS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.IsRootAvailable\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">true</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.OperatingSystemType\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iOS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PlatformId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">VSKIZeZiu46kYGWe/5pEXLdfIeaumvYXvb4c7Mh7cII=</saml1:AttributeValue></saml1:Attribute><saml1:AttributeAttributeName=\"SmartDevice.OperatingSystemVersion\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">10.2</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceManufacturer\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Apple</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthMethods\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"xsi:type=\"xs:string\">DEVICE:PIN,DEVICE</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.DeviceId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PushSent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">false</saml1:AttributeValue></saml1:Attribute></saml1:AttributeStatement><saml1:AuthenticationStatement samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhq346564rtetwkjheq==\"2018-01-19T15:15:50.846Z\" AuthenticationMethod=\"SmartDevice\"><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject></saml1:AuthenticationStatement></saml1:Assertion></saml1p:Response>";
        String responseContentStringTwoEqualChars = "<saml1p:Response xmlns:saml1p=\"urn:oasis:names:tc:SAML:1.0:protocol\" xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" IssueInstant=\"2018-01-19T15:15:50.846Z\" MajorVersion=\"1\" MinorVersion=\"1\" ResponseID=\"_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/><ds:SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#dsa-sha1\"/><ds:Reference URI=\"#_7a56e346d972be6bd5856ccb4abd9d69\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"><ec:InclusiveNamespacesxmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\" PrefixList=\"xs\"/></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/><ds:DigestValue>MbbeA12WYeVGyeXxN9xaJi09+dnWdHfSPgbNOq0hh/E=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Wo+E1UTNBNWIdk/DV/8x6UEyLX+N/f5AY+0vJFS8pIRiXnhuUn+MUA==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate><ds:X509Certificate>MIIDCjCCAskCBE5c1FwwCQYHKoZIzjgEAzBsMRwwGgYJKoZIhvcNAQkBFg1pbmZvQGVuY2FwLm5v\nMQswCQYDVQQGEwJOTzERMA8GA1UECgwIRW5jYXAgQVMxLDAqBgNVBAMMI0VuY2FwIFNlcnZlciBm\nb3IgU2VjdXJlIEFjY2VzcyBUZXN0MB4XDTExMDgzMDEyMTUyNFoXDTIxMDgyNzEyMTUyNFowbDEc\nMBoGCSqGSIb3DQEJARYNaW5mb0BlbmNhcC5ubzELMAkGA1UEBhMCTk8xETAPBgNVBAoMCEVuY2Fw\nIEFTMSwwKgYDVQQDDCNFbmNhcCBTZXJ2ZXIgZm9yIFNlY3VyZSBBY2Nlc3MgVGVzdDCCAbgwggEs\nBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9\njVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD\n9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGB\nAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYT\nt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaS\ni2ZegHtVJWQBTDv+z0kqA4GFAAKBgQD0RdfM3uwgCumsLW8tRFMMTvudXxp53ihmfdNHfnMLut1t\nXzm0W/XDVk6wiDtFW6vYDt1lcdDVqUX1aOJ5cpvaxzvnXz9VxsUGZn5Zqucfjl02O+eON5NY/kcX\n8t545PTQoR/JuBiBidnVegEuqmCVI4UAVdK5d91TRAU+E0ToLzAJBgcqhkjOOAQDAzAAMC0CFQCL\nqDlU3PHl46q2BoaMkrOXiDBLKAIUOBQ5ZoR20whqV4zweMl8Elsni20=</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml1p:Status><saml1p:StatusCode Value=\"saml1p:Success\"/></saml1p:Status><saml1:Assertion xmlns:saml1=\"urn:oasis:names:tc:SAML:1.0:assertion\" AssertionID=\"_5919a0b81e8fca63bca8ec4eca3c2ca4\"IssueInstant=\"2018-01-19T15:15:50.846Z\" Issuer=\"encap\" MajorVersion=\"1\" MinorVersion=\"1\"><saml1:Conditions NotBefore=\"2018-01-19T15:15:50.846Z\" NotOnOrAfter=\"2018-01-19T15:16:50.846Z\"><saml1:DoNotCacheCondition/></saml1:Conditions><saml1:AttributeStatement><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject><saml1:AttributeAttributeName=\"SmartDevice.AttributesHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">uNGrfDHYdyPwADLebSqABdKhpBPKoJw5PlnN1Azzmik=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.UserAgent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Mozilla/5.0 (iPhone;CPU iPhone OS 10_2 like Mac OS X) AppleWebKit/602.3.12 (KHTML, like Gecko) Mobile/14C92</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthenticationLevel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">TWO_FACTOR</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.SessionId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1927793404</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.UserId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Date\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">1516374950846</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceModel\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iPhone8,1</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.RegistrationId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.ApplicationHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.Status\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SUCCESS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.IsRootAvailable\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">true</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.OperatingSystemType\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">iOS</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PlatformId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceHash\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">VSKIZeZiu46kYGWe/5pEXLdfIeaumvYXvb4c7Mh7cII=</saml1:AttributeValue></saml1:Attribute><saml1:AttributeAttributeName=\"SmartDevice.OperatingSystemVersion\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">10.2</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"SmartDevice.DeviceManufacturer\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">Apple</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.AuthMethods\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"xsi:type=\"xs:string\">DEVICE:PIN,DEVICE</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.DeviceId\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">SmartDevice</saml1:AttributeValue></saml1:Attribute><saml1:Attribute AttributeName=\"encap.PushSent\" AttributeNamespace=\"urn:no:encap:server\"><saml1:AttributeValue xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">false</saml1:AttributeValue></saml1:Attribute></saml1:AttributeStatement><saml1:AuthenticationStatement samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhertert246qwekjheq===\"2018-01-19T15:15:50.846Z\" AuthenticationMethod=\"SmartDevice\"><saml1:Subject><saml1:NameIdentifier Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">a58c2dc2-a755-40b8-9f3d-1a3b85beca99</saml1:NameIdentifier><saml1:SubjectConfirmation><saml1:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml1:ConfirmationMethod></saml1:SubjectConfirmation></saml1:Subject></saml1:AuthenticationStatement></saml1:Assertion></saml1p:Response>";

        String samlObject1 = EncapUtils.getSamlObjectFromResponseContent(responseContentStringOneEqualChar);
        String samlObject2 = EncapUtils.getSamlObjectFromResponseContent(responseContentStringTwoEqualChars);
        assertEquals("samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhq346564rtetwkjheq=", samlObject1);
        assertEquals("samlObjectRandomStringForTestingPurposesweGERgwerfgvjsdlkfjdlkjhtkrjghnvbjdajfbejhatgagrflzsdygbvjz,dhfgbetrkyhkfhggksdjhgskjdhfgaskjrhertert246qwekjheq==", samlObject2);
    }

    @Test
    public void testGetActivationSessionId() {
        String soapStringWithoutError = "<?xml version='1.0' encoding='UTF-8'?><soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"><soapenv:Body><ns11:SECSMobileActivationSessionUpdate_V1_0OutputArgs xmlns:ns11=\"http://mobileactivation.security.edb.com\"><ns11:MobileActivationSessionUpdateResponse><ns11:activationsession>hejhejsxcbnktdhfksuhku21h4k2h53khterkjhkjdfhgkjjkhkejh455</ns11:activationsession></ns11:MobileActivationSessionUpdateResponse><ns11:ResponseState><ns2:ErrorCode xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">0</ns2:ErrorCode><ns2:Severity xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">0</ns2:Severity><ns2:ComponentId xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">201</ns2:ComponentId><ns2:Message xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">Success</ns2:Message></ns11:ResponseState></ns11:SECSMobileActivationSessionUpdate_V1_0OutputArgs></soapenv:Body></soapenv:Envelope>";

        String soapStringWithWrongActivationCodeError = "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"><soapenv:Body><ns11:SECSMobileActivationSessionUpdate_V1_0OutputArgs xmlns:ns11=\"http://mobileactivation.security.edb.com\"><ns11:ResponseState><ns2:ErrorCode xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">251</ns2:ErrorCode><ns2:Severity xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">2</ns2:Severity><ns2:ComponentId xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">201</ns2:ComponentId><ns2:Message xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">Activation failure. Either username or activation code is incorrect.</ns2:Message><ns2:LogSequence xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\">-7189236383795152914</ns2:LogSequence></ns11:ResponseState></ns11:SECSMobileActivationSessionUpdate_V1_0OutputArgs></soapenv:Body></soapenv:Envelope>";

        String activationSessionIdWithoutError = EncapUtils.getActivationSessionId(soapStringWithoutError);
        String activationSessionIdWithWrongActivationCodeError =
                EncapUtils.getActivationSessionId(soapStringWithWrongActivationCodeError);
        assertEquals("hejhejsxcbnktdhfksuhku21h4k2h53khterkjhkjdfhgkjjkhkejh455", activationSessionIdWithoutError);
        assertEquals(null, activationSessionIdWithWrongActivationCodeError);
    }

    @Test
    public void testGetSecurityValuesList() {
        String soapStringActivation = "<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap:Body><ns3:mobileActivationCreateResponse xmlns:ns6=\"urn:sam.sec.fs.evry.com:domain:mobileuseractivationinfo:v1\" xmlns:ns5=\"urn:sam.sec.fs.evry.com:ws:mobileuseractivationsession:v2\" xmlns:ns4=\"urn:sam.sec.fs.evry.com:domain:common:v2\" xmlns:ns3=\"urn:sam.sec.fs.evry.com:ws:mobileactivation:v1\" xmlns:ns2=\"urn:sam.sec.fs.evry.com:domain:activation:v1\" xmlns=\"http://edb.com/ws/WSCommon_v21\"><ns4:ResponseState><ErrorCode>0</ErrorCode><Severity>0</Severity><ComponentId>201</ComponentId><StrErrorCode xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><Message>OK</Message><NativeError xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><LogSequence xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/></ns4:ResponseState><ns3:so>dlkfjlgkjvblkdfjlhkjyertlsidvxlcbkjfglnkdfjglaskfjsak34t5465lykjlvkjlkgdf=</ns3:so><ns3:samUserId>EN123456_46_35EE822C-XXX-XXX-88</ns3:samUserId></ns3:mobileActivationCreateResponse></soap:Body></soap:Envelope>";
        String soapStringAuthentication = "<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap:Body><ns6:mobileAuthSessionReadResponse xmlns:ns7=\"urn:sam.sec.fs.evry.com:domain:mobileuseractivationinfo:v1\" xmlns:ns6=\"urn:sam.sec.fs.evry.com:ws:mobileauthentication:v1\" xmlns:ns5=\"urn:mobile.security.fs.edb.com:domain:mobileapplication:v1\" xmlns:ns4=\"urn:sam.sec.fs.evry.com:ws:mobileuseractivationsession:v2\" xmlns:ns3=\"urn:sam.sec.fs.evry.com:domain:authentication:v1\" xmlns:ns2=\"urn:sam.sec.fs.evry.com:domain:common:v2\" xmlns=\"http://edb.com/ws/WSCommon_v21\"><ns2:ResponseState><ErrorCode>0</ErrorCode><Severity>0</Severity><ComponentId>201</ComponentId><StrErrorCode xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><Message>OK</Message><NativeError xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><LogSequence xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/></ns2:ResponseState><ns3:samUserId>Edfgddf122-XXXXxx-XXXX_xxfgf</ns3:samUserId><ns3:so>sdfslkjehlhsglvjshdfgliuhrlu43h5456lh54ltkhekjrtherkjt=</ns3:so></ns6:mobileAuthSessionReadResponse></soap:Body></soap:Envelope>";

        List<String> activationValues = EncapUtils.getSecurityValuesList(soapStringActivation);
        assertThat(activationValues, notNullValue());
        assertEquals("dlkfjlgkjvblkdfjlhkjyertlsidvxlcbkjfglnkdfjglaskfjsak34t5465lykjlvkjlkgdf=",
                activationValues.get(0));
        assertEquals("EN123456_46_35EE822C-XXX-XXX-88", activationValues.get(1));

        List<String> authenticationValues = EncapUtils.getSecurityValuesList(soapStringAuthentication);
        assertThat(authenticationValues, notNullValue());
        assertEquals("sdfslkjehlhsglvjshdfgliuhrlu43h5456lh54ltkhekjrtherkjt=", authenticationValues.get(0));
        assertEquals("Edfgddf122-XXXXxx-XXXX_xxfgf", authenticationValues.get(1));
    }

    @Test
    public void testGetSecurityTokenFromSoapString() {
        String soapStringActivation = "<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap:Body><SECSMobileUserCreate_V1_0OutputArgs xmlns:ns2=\"http://edb.com/ws/WSCommon_v21\" xmlns=\"http://mobileactivation.security.edb.com\"><MobileUserCreateResponse><securityToken>03111012010700</securityToken></MobileUserCreateResponse><ResponseState><ns2:ErrorCode>0</ns2:ErrorCode><ns2:Severity>0</ns2:Severity><ns2:ComponentId>201</ns2:ComponentId><ns2:StrErrorCode xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><ns2:Message>OK</ns2:Message><ns2:NativeError xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/><ns2:LogSequence xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:nil=\"true\"/></ResponseState></SECSMobileUserCreate_V1_0OutputArgs></soap:Body></soap:Envelope>";

        String securityToken = EncapUtils.getSecurityToken(soapStringActivation);
        assertEquals("03111012010700", securityToken);
    }

    private Map<String, String> setupEncapStorageForTest() {
        Map<String, String> storage = Maps.newHashMap();

        storage.put(EncapConstants.Storage.CLIENT_SALT_CURRENT_KEY_ID, Integer.toString(-1256450962));
        storage.put(EncapConstants.Storage.B64_APPLICATION_HASH, "BDAU1jUdpq90JondTdP7zFwR8iaKCxcHlrmYgsTbOGk=");
        storage.put(EncapConstants.Storage.B64_DEVICE_HASH, "VSKIZeZiu46kYGWe/5pEXLdfIeaumvYXvb4c7Mh7cII=");
        storage.put(EncapConstants.Storage.DEVICE_UUID, "8AFA762F-ADA2-41C7-93A5-06E605F54D2C");
        storage.put(EncapConstants.Storage.REGISTRATION_ID, "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX1");
        storage.put(EncapConstants.Storage.B64_AUTHENTICATION_KEY, "dfgdfgsdflh3453645fgRBC+4w3K5k=");
        storage.put(EncapConstants.Storage.B64_AUTHENTICATION_KEY_WITHOUT_PIN,
                "fdjlbkjhlk45j6lkrgjsdlvhhlshdfMBMXQgHTLRw=");
        storage.put(EncapConstants.Storage.B64_CHALLENGE_RESPONSE, "dfhGHGMHJFDVdFDfessDJLwcAIw==");
        storage.put(EncapConstants.Storage.B64_CHALLENGE_RESPONSE_WITHOUT_PIN, "r9/DHTYefcdflDFSGzwyJwEg==");
        storage.put(EncapConstants.Storage.B64_TOTP_KEY, "mWtO8WgKsODjLQK6QQaBf7MQDEgfheRH4yJZioIYd3Q=");
        storage.put(EncapConstants.Storage.B64_SALT_HASH, "dflkfdnbFGFHghfgvldajncv45eCBEttHMQ=");
        storage.put(EncapConstants.Storage.B64_RESPONSE_CURRENT, "Ft3pIosdfGFHgfFdssaTQavw==");
        storage.put(EncapConstants.Storage.APPLICATION_VERSION, "108");
        storage.put(EncapConstants.Storage.ENCAP_API_VERSION, "3.3.6");

        return storage;
    }
}
