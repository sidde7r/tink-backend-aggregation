load("@io_bazel_rules_docker//container:container.bzl", "container_image", "container_layer")
load("@rules_java//java:defs.bzl", "java_binary", "java_library")
load("@rules_pkg//:pkg.bzl", "pkg_tar")
load("//tools/bzl:template_file.bzl", "templated_file")

container_layer(
    name = "chromium_deps_for_java11",
    debs = [
        "@install-info_6.5.0.dfsg.1-4b1_amd64//file",
        "@libapparmor1_2.13.2-10_amd64//file",
        "@libcap2_2.25-2_amd64//file",
        "@libargon2-1_020171227-0.2_amd64//file",
        "@dmsetup_1.02.155-3_amd64//file",
        "@libdevmapper1.02.1_1.02.155-3_amd64//file",
        "@libjson-c3_0.12.1ds-2deb10u1_amd64//file",
        "@libcryptsetup12_2.1.0-5deb10u2_amd64//file",
        "@libidn11_1.33-2.2_amd64//file",
        "@libip4tc0_1.8.2-4_amd64//file",
        "@libkmod2_26-1_amd64//file",
        "@systemd_241-7deb10u8_amd64//file",
        "@systemd-sysv_241-7deb10u8_amd64//file",
        "@perl-modules-5.28_5.28.1-6deb10u1_all//file",
        "@libgdbm6_1.18.1-4_amd64//file",
        "@libgdbm-compat4_1.18.1-4_amd64//file",
        "@libperl5.28_5.28.1-6deb10u1_amd64//file",
        "@perl_5.28.1-6deb10u1_amd64//file",
        "@libpython3.7-minimal_3.7.3-2deb10u3_amd64//file",
        "@python3.7-minimal_3.7.3-2deb10u3_amd64//file",
        "@python3-minimal_3.7.3-1_amd64//file",
        "@mime-support_3.62_all//file",
        "@libmpdec2_2.4.2-2_amd64//file",
        "@libpython3.7-stdlib_3.7.3-2deb10u3_amd64//file",
        "@python3.7_3.7.3-2deb10u3_amd64//file",
        "@libpython3-stdlib_3.7.3-1_amd64//file",
        "@python3_3.7.3-1_amd64//file",
        "@libdebian-installer4_0.119_amd64//file",
        "@libslang2_2.3.2-2_amd64//file",
        "@libnewt0.52_0.52.20-8_amd64//file",
        "@libtextwrap1_0.1-14.2_amd64//file",
        "@cdebconf_0.249_amd64//file",
        "@libelf1_0.176-1.1_amd64//file",
        "@libmnl0_1.0.4-2_amd64//file",
        "@libxtables12_1.8.2-4_amd64//file",
        "@libcap2-bin_2.25-2_amd64//file",
        "@iproute2_4.20.0-2deb10u1_amd64//file",
        "@netbase_5.6_all//file",
        "@libdbus-1-3_1.12.20-0deb10u1_amd64//file",
        "@dbus_1.12.20-0deb10u1_amd64//file",
        "@libmagic-mgc_5.35-4deb10u2_amd64//file",
        "@libmagic1_5.35-4deb10u2_amd64//file",
        "@file_5.35-4deb10u2_amd64//file",
        "@krb5-locales_1.17-3deb10u3_all//file",
        "@libnss-systemd_241-7deb10u8_amd64//file",
        "@libpam-systemd_241-7deb10u8_amd64//file",
        "@hicolor-icon-theme_0.17-2_all//file",
        "@libglib2.0-0_2.58.3-2deb10u3_amd64//file",
        "@libjpeg62-turbo_1.5.2-2deb10u1_amd64//file",
        "@libjbig0_2.1-3.1b2_amd64//file",
        "@libwebp6_0.6.1-2deb10u1_amd64//file",
        "@libtiff5_4.1.0git191117-2deb10u2_amd64//file",
        "@libxau6_1.0.8-1b2_amd64//file",
        "@libbsd0_0.9.1-2deb10u1_amd64//file",
        "@libxdmcp6_1.1.2-3_amd64//file",
        "@libxcb1_1.13.1-2_amd64//file",
        "@libx11-data_1.6.7-1deb10u2_all//file",
        "@libx11-6_1.6.7-1deb10u2_amd64//file",
        "@libicu63_63.1-6deb10u1_amd64//file",
        "@libxml2_2.9.4dfsg1-7deb10u2_amd64//file",
        "@shared-mime-info_1.10-1_amd64//file",
        "@libgdk-pixbuf2.0-common_2.38.1dfsg-1_all//file",
        "@libgdk-pixbuf2.0-0_2.38.1dfsg-1_amd64//file",
        "@gtk-update-icon-cache_3.24.5-1_amd64//file",
        "@libpixman-1-0_0.36.0-1_amd64//file",
        "@libxcb-render0_1.13.1-2_amd64//file",
        "@libxcb-shm0_1.13.1-2_amd64//file",
        "@libxext6_1.3.3-1b2_amd64//file",
        "@libxrender1_0.9.10-1_amd64//file",
        "@libcairo2_1.16.0-4deb10u1_amd64//file",
        "@libcroco3_0.6.12-3_amd64//file",
        "@libfribidi0_1.0.5-3.1deb10u1_amd64//file",
        "@libthai-data_0.1.28-2_all//file",
        "@libdatrie1_0.2.12-2_amd64//file",
        "@libthai0_0.1.28-2_amd64//file",
        "@libpango-1.0-0_1.42.4-8deb10u1_amd64//file",
        "@libgraphite2-3_1.3.13-7_amd64//file",
        "@libharfbuzz0b_2.3.1-1_amd64//file",
        "@libpangoft2-1.0-0_1.42.4-8deb10u1_amd64//file",
        "@libpangocairo-1.0-0_1.42.4-8deb10u1_amd64//file",
        "@librsvg2-2_2.44.10-2.1_amd64//file",
        "@librsvg2-common_2.44.10-2.1_amd64//file",
        "@adwaita-icon-theme_3.30.1-1_all//file",
        "@libatspi2.0-0_2.30.0-7_amd64//file",
        "@libxi6_1.7.9-1_amd64//file",
        "@x11-common_7.719_all//file",
        "@libxtst6_1.2.3-1_amd64//file",
        "@at-spi2-core_2.30.0-7_amd64//file",
        "@libisl19_0.20-2_amd64//file",
        "@libmpfr6_4.0.2-1_amd64//file",
        "@libmpc3_1.1.0-1_amd64//file",
        "@cpp-8_8.3.0-6_amd64//file",
        "@cpp_8.3.0-1_amd64//file",
        "@dbus-user-session_1.12.20-0deb10u1_amd64//file",
        "@dbus-x11_1.12.20-0deb10u1_amd64//file",
        "@libdconf1_0.30.1-2_amd64//file",
        "@dconf-service_0.30.1-2_amd64//file",
        "@dconf-gsettings-backend_0.30.1-2_amd64//file",
        "@fonts-liberation_1.07.4-9_all//file",
        "@libproxy1v5_0.4.15-5deb10u1_amd64//file",
        "@glib-networking-common_2.58.0-2deb10u2_all//file",
        "@glib-networking-services_2.58.0-2deb10u2_amd64//file",
        "@gsettings-desktop-schemas_3.28.1-1_all//file",
        "@glib-networking_2.58.0-2deb10u2_amd64//file",
        "@libroken18-heimdal_7.5.0dfsg-3_amd64//file",
        "@libasn1-8-heimdal_7.5.0dfsg-3_amd64//file",
        "@libasound2-data_1.1.8-1_all//file",
        "@libasound2_1.1.8-1_amd64//file",
        "@libatk1.0-data_2.30.0-2_all//file",
        "@libatk1.0-0_2.30.0-2_amd64//file",
        "@libatk-bridge2.0-0_2.30.0-5_amd64//file",
        "@libatm1_2.5.1-2_amd64//file",
        "@libauthen-sasl-perl_2.1600-1_all//file",
        "@libavahi-common-data_0.7-4deb10u1_amd64//file",
        "@libavahi-common3_0.7-4deb10u1_amd64//file",
        "@libavahi-client3_0.7-4deb10u1_amd64//file",
        "@libbrotli1_1.0.7-2deb10u1_amd64//file",
        "@libcairo-gobject2_1.16.0-4deb10u1_amd64//file",
        "@liblcms2-2_2.9-3_amd64//file",
        "@libcolord2_1.4.3-4_amd64//file",
        "@libkeyutils1_1.6-6_amd64//file",
        "@libkrb5support0_1.17-3deb10u3_amd64//file",
        "@libk5crypto3_1.17-3deb10u3_amd64//file",
        "@libkrb5-3_1.17-3deb10u3_amd64//file",
        "@libgssapi-krb5-2_1.17-3deb10u3_amd64//file",
        "@libcups2_2.2.10-6deb10u4_amd64//file",
        "@libnghttp2-14_1.36.0-2deb10u1_amd64//file",
        "@librtmp1_2.420151223.gitfa8646d.1-2_amd64//file",
        "@libssh2-1_1.8.0-2.1_amd64//file",
        "@libcurl3-gnutls_7.64.0-4deb10u2_amd64//file",
        "@libnspr4_4.20-1_amd64//file",
        "@libnss3_3.42.1-1deb10u3_amd64//file",
        "@libcurl3-nss_7.64.0-4deb10u2_amd64//file",
        "@libcurl4_7.64.0-4deb10u2_amd64//file",
        "@libdata-dump-perl_1.23-1_all//file",
        "@libdrm-common_2.4.97-1_all//file",
        "@libdrm2_2.4.97-1_amd64//file",
        "@libdrm-amdgpu1_2.4.97-1_amd64//file",
        "@libpciaccess0_0.14-1_amd64//file",
        "@libdrm-intel1_2.4.97-1_amd64//file",
        "@libdrm-nouveau2_2.4.97-1_amd64//file",
        "@libdrm-radeon1_2.4.97-1_amd64//file",
        "@libedit2_3.1-20181209-1_amd64//file",
        "@libencode-locale-perl_1.05-1_all//file",
        "@libepoxy0_1.5.3-0.1_amd64//file",
        "@libevent-core-2.1-6_2.1.8-stable-4_amd64//file",
        "@libevent-pthreads-2.1-6_2.1.8-stable-4_amd64//file",
        "@libipc-system-simple-perl_1.25-4_all//file",
        "@libfile-basedir-perl_0.08-1_all//file",
        "@liburi-perl_1.76-1_all//file",
        "@libfile-desktopentry-perl_0.22-1_all//file",
        "@libtimedate-perl_2.3000-2deb10u1_all//file",
        "@libhttp-date-perl_6.02-1_all//file",
        "@libfile-listing-perl_6.04-1_all//file",
        "@libfile-mimeinfo-perl_0.29-1_all//file",
        "@libfont-afm-perl_1.20-2_all//file",
        "@libfontenc1_1.1.3-1b2_amd64//file",
        "@libwayland-server0_1.16.0-1_amd64//file",
        "@libgbm1_18.3.6-2deb10u1_amd64//file",
        "@libgdk-pixbuf2.0-bin_2.38.1dfsg-1_amd64//file",
        "@libglapi-mesa_18.3.6-2deb10u1_amd64//file",
        "@libllvm7_7.0.1-8deb10u2_amd64//file",
        "@libsensors-config_3.5.0-3_all//file",
        "@libsensors5_3.5.0-3_amd64//file",
        "@libgl1-mesa-dri_18.3.6-2deb10u1_amd64//file",
        "@libglib2.0-data_2.58.3-2deb10u3_all//file",
        "@libglvnd0_1.1.0-1_amd64//file",
        "@libx11-xcb1_1.6.7-1deb10u2_amd64//file",
        "@libxcb-dri2-0_1.13.1-2_amd64//file",
        "@libxcb-dri3-0_1.13.1-2_amd64//file",
        "@libxcb-glx0_1.13.1-2_amd64//file",
        "@libxcb-present0_1.13.1-2_amd64//file",
        "@libxcb-sync1_1.13.1-2_amd64//file",
        "@libxfixes3_5.0.3-1_amd64//file",
        "@libxdamage1_1.1.4-3b3_amd64//file",
        "@libxshmfence1_1.3-1_amd64//file",
        "@libxxf86vm1_1.1.4-1b2_amd64//file",
        "@libglx-mesa0_18.3.6-2deb10u1_amd64//file",
        "@libheimbase1-heimdal_7.5.0dfsg-3_amd64//file",
        "@libhcrypto4-heimdal_7.5.0dfsg-3_amd64//file",
        "@libwind0-heimdal_7.5.0dfsg-3_amd64//file",
        "@libhx509-5-heimdal_7.5.0dfsg-3_amd64//file",
        "@libkrb5-26-heimdal_7.5.0dfsg-3_amd64//file",
        "@libheimntlm0-heimdal_7.5.0dfsg-3_amd64//file",
        "@libgssapi3-heimdal_7.5.0dfsg-3_amd64//file",
        "@libjson-glib-1.0-common_1.4.4-2_all//file",
        "@libjson-glib-1.0-0_1.4.4-2_amd64//file",
        "@libsoup2.4-1_2.64.2-2_amd64//file",
        "@libsoup-gnome2.4-1_2.64.2-2_amd64//file",
        "@librest-0.7-0_0.8.1-1_amd64//file",
        "@libwayland-client0_1.16.0-1_amd64//file",
        "@libwayland-cursor0_1.16.0-1_amd64//file",
        "@libwayland-egl1_1.16.0-1_amd64//file",
        "@libxcomposite1_0.4.4-2_amd64//file",
        "@libxcursor1_1.1.15-2_amd64//file",
        "@libxinerama1_1.1.4-2_amd64//file",
        "@xkb-data_2.26-2_all//file",
        "@libxkbcommon0_0.8.2-1_amd64//file",
        "@libxrandr2_1.5.1-1_amd64//file",
        "@libgtk-3-common_3.24.5-1_all//file",
        "@libgtk-3-0_3.24.5-1_amd64//file",
        "@libgtk-3-bin_3.24.5-1_amd64//file",
        "@libhtml-tagset-perl_3.20-3_all//file",
        "@libhtml-parser-perl_3.72-3b3_amd64//file",
        "@libio-html-perl_1.001-1_all//file",
        "@liblwp-mediatypes-perl_6.02-1_all//file",
        "@libhttp-message-perl_6.18-1_all//file",
        "@libhtml-form-perl_6.03-1_all//file",
        "@libhtml-tree-perl_5.07-2_all//file",
        "@libhtml-format-perl_2.12-1_all//file",
        "@libhttp-cookies-perl_6.04-1_all//file",
        "@libhttp-daemon-perl_6.01-3_all//file",
        "@libhttp-negotiate-perl_6.01-1_all//file",
        "@libice6_1.0.9-2_amd64//file",
        "@perl-openssl-defaults_3_amd64//file",
        "@libnet-ssleay-perl_1.85-2b1_amd64//file",
        "@libio-socket-ssl-perl_2.060-3_all//file",
        "@libio-stringy-perl_2.111-3_all//file",
        "@libnet-http-perl_6.18-1_all//file",
        "@libtry-tiny-perl_0.30-1_all//file",
        "@libwww-robotrules-perl_6.02-1_all//file",
        "@libwww-perl_6.36-2_all//file",
        "@liblwp-protocol-https-perl_6.07-2_all//file",
        "@libnet-smtp-ssl-perl_1.04-1_all//file",
        "@libmailtools-perl_2.18-1_all//file",
        "@libxml-parser-perl_2.44-4_amd64//file",
        "@libxml-twig-perl_3.50-1.1_all//file",
        "@libnet-dbus-perl_1.1.0-5b1_amd64//file",
        "@libopts25_5.18.12-4_amd64//file",
        "@libpam-cap_2.25-2_amd64//file",
        "@libpython3.7_3.7.3-2deb10u3_amd64//file",
        "@libsm6_1.2.3-1_amd64//file",
        "@libssh-4_0.9.5-1deb11u1_amd64.deb//file",
        "@libtext-iconv-perl_1.7-5b7_amd64//file",
        "@libtie-ixhash-perl_1.23-2_all//file",
        "@libx11-protocol-perl_0.56-7_all//file",
        "@libxt6_1.1.5-1b3_amd64//file",
        "@libxmu6_1.1.2-2b3_amd64//file",
        "@libxpm4_3.5.12-1_amd64//file",
        "@libxaw7_1.0.13-1b2_amd64//file",
        "@libxcb-shape0_1.13.1-2_amd64//file",
        "@libxft2_2.3.2-2_amd64//file",
        "@libxml-xpathengine-perl_0.14-1_all//file",
        "@libxmuu1_1.1.2-2b3_amd64//file",
        "@libxv1_1.0.11-1_amd64//file",
        "@libxxf86dga1_1.1.4-1b3_amd64//file",
        "@ntp_4.2.8p12dfsg-4_amd64//file",
        "@python3-ntp_1.1.3dfsg1-2deb10u1_amd64//file",
        "@sntp_4.2.8p12dfsg-4_amd64//file",
        "@ttf-bitstream-vera_1.10-8_all//file",
        "@libglx0_1.1.0-1_amd64//file",
        "@libgl1_1.1.0-1_amd64//file",
        "@x11-utils_7.74_amd64//file",
        "@x11-xserver-utils_7.78_amd64//file",
        "@xdg-user-dirs_0.17-2_amd64//file",
        "@xdg-utils_1.1.3-1deb10u1_all//file",
        "@coreutils_8.30-3_amd64//file",
        "@dpkg_1.19.7_amd64//file",
        "@login_4.5-1.1_amd64//file",
        "@perl-base_5.28.1-6deb10u1_amd64//file",
        "@tar_1.30dfsg-6_amd64//file",
        "@util-linux_2.33.1-0.1_amd64//file",
        "@init-system-helpers_1.56nmu1_all//file",
        "@debconf_1.5.71deb10u1_all//file",
        "@libpam-modules_1.3.1-5_amd64//file",
        "@libsystemd0_241-7deb10u8_amd64//file",
        "@mount_2.33.1-0.1_amd64//file",
        "@libpam-modules-bin_1.3.1-5_amd64//file",
        "@libpam-runtime_1.3.1-5_all//file",
        "@passwd_4.5-1.1_amd64//file",
        "@adduser_3.118_all//file",
        "@libacl1_2.2.53-4_amd64//file",
        "@libattr1_2.4.48-4_amd64//file",
        "@libaudit-common_2.8.4-3_all//file",
        "@libaudit1_2.8.4-3_amd64//file",
        "@libblkid1_2.33.1-0.1_amd64//file",
        "@libbz2-1.0_1.0.6-9.2deb10u1_amd64//file",
        "@libc6_2.28-10_amd64//file",
        "@libcap-ng0_0.7.9-2_amd64//file",
        "@libdb5.3_5.3.28dfsg1-0.5_amd64//file",
        "@libgcc1_8.3.0-6_amd64//file",
        "@libgcrypt20_1.8.4-5deb10u1_amd64//file",
        "@libgmp10_6.1.2dfsg-4_amd64//file",
        "@libgnutls30_3.6.7-4deb10u7_amd64//file",
        "@libgpg-error0_1.35-1_amd64//file",
        "@libidn2-0_2.0.5-1deb10u1_amd64//file",
        "@liblz4-1_1.8.3-1deb10u1_amd64//file",
        "@liblzma5_5.2.4-1_amd64//file",
        "@libmount1_2.33.1-0.1_amd64//file",
        "@libncursesw6_6.120181013-2deb10u2_amd64//file",
        "@libp11-kit0_0.23.15-2deb10u1_amd64//file",
        "@libpam0g_1.3.1-5_amd64//file",
        "@libpcre3_8.39-12_amd64//file",
        "@libseccomp2_2.3.3-4_amd64//file",
        "@libselinux1_2.8-1b1_amd64//file",
        "@libsemanage-common_2.8-2_all//file",
        "@libsemanage1_2.8-2_amd64//file",
        "@libsepol1_2.8-1_amd64//file",
        "@libsmartcols1_2.33.1-0.1_amd64//file",
        "@libstdc6_8.3.0-6_amd64//file",
        "@libtasn1-6_4.13-3_amd64//file",
        "@libtinfo6_6.120181013-2deb10u2_amd64//file",
        "@libudev1_241-7deb10u8_amd64//file",
        "@libunistring2_0.9.10-1_amd64//file",
        "@libuuid1_2.33.1-0.1_amd64//file",
        "@libzstd1_1.3.8dfsg-3deb10u2_amd64//file",
        "@zlib1g_1.2.11.dfsg-1_amd64//file",
        "@tzdata_2021a-0deb10u2_all//file",
        "@readline-common_7.0-5_all//file",
        "@sensible-utils_0.0.12_all//file",
        "@ucf_3.0038nmu1_all//file",
        "@wget_1.20.1-1.1_amd64//file",
        "@ca-certificates_20200601deb10u2_all//file",
        "@fontconfig_2.13.1-2_amd64//file",
        "@fontconfig-config_2.13.1-2_all//file",
        "@fonts-dejavu-core_2.37-1_all//file",
        "@libcom-err2_1.44.5-1deb10u3_amd64//file",
        "@libexpat1_2.2.6-2deb10u1_amd64//file",
        "@libfontconfig1_2.13.1-2_amd64//file",
        "@libfreetype6_2.9.1-3deb10u2_amd64//file",
        "@libldap-2.4-2_2.4.47dfsg-3deb10u6_amd64//file",
        "@libldap-common_2.4.47dfsg-3deb10u6_all//file",
        "@libpcre2-8-0_10.32-5_amd64//file",
        "@libpng16-16_1.6.36-6_amd64//file",
        "@libpsl5_0.20.2-2_amd64//file",
        "@libsasl2-2_2.1.27dfsg-1deb10u1_amd64//file",
        "@libsasl2-modules-db_2.1.27dfsg-1deb10u1_amd64//file",
        "@libsqlite3-0_3.27.2-3deb10u1_amd64//file",
        "@libssl1.1_1.1.1d-0deb10u7_amd64//file",
        "@lsb-base_10.2019051400_all//file",
        "@openssl_1.1.1d-0deb10u7_amd64//file",
        "@chrony_3.4-4deb10u1_amd64//file",
        "@ntpsec_1.1.3dfsg1-2deb10u1_amd64//file",
        "@openntpd_6.2p3-4_amd64//file",
        "@gcc-10-base_10.2.1-6_amd64//file",
        "@libcrypt1_4.4.18-4_amd64//file",
        "@libffi6_3.2.1-9_amd64//file",
        "@libgcc-s1_10.2.1-6_amd64//file",
        "@libip4tc2_1.8.7-1_amd64//file",
        "@libreadline8_8.1-1_amd64//file",
        "@systemd-timesyncd_247.3-6_amd64//file",
        "@libnettle6_3.4.1-1deb10u1_amd64//file",
        "@libhogweed4_3.4.1-1deb10u1_amd64//file",
    ],
)

java_library(
    name = "service",
    srcs = glob(["src/main/**/*.java"]),
    data = [
        "//data",
    ],
    visibility = ["//visibility:public"],
    runtime_deps = [
        # AggregatorConfigurationsRepository needs to find HibernateEntityManagerFactory
        "@aggregation//:org_hibernate_hibernate_entitymanager",
    ],
    deps = [
        "//src/aggregation/lib/src/main/java/se/tink/backend/aggregation/cli",
        "//src/aggregation/lib/src/main/java/se/tink/backend/aggregation/configuration",
        "//src/aggregation/lib/src/main/java/se/tink/backend/aggregation/configuration/guice/modules",
        "//src/aggregation/lib/src/main/java/se/tink/backend/aggregation/storage/database/daos",
        "//src/aggregation/lib/src/main/java/se/tink/backend/aggregation/workers/worker",
        "//src/integration/tpp_secrets_service/client",
        "//src/libraries/draining",
        "//src/libraries/dropwizard_utils",
        "//src/libraries/queue_lib",
        "//third_party:com_codahale_metrics_metrics_healthchecks",
        "//third_party:com_google_inject_guice",
        "//third_party:io_dropwizard_dropwizard_configuration",
        "//third_party:io_dropwizard_dropwizard_core",
        "//third_party:io_prometheus_simpleclient",
        "//third_party:org_slf4j_slf4j_api",
        "//third_party/dropwizard",
        "@aggregation//:com_fasterxml_jackson_datatype_jackson_datatype_jsr310",
        "@aggregation//:com_google_guava_guava",
        "@aggregation//:com_netflix_governator_governator",
        "@tink_backend//src/libraries/unleash",
    ],
)

java_binary(
    name = "bin",
    args = [
        "server",
        "$(location :development_config.out)",
    ],
    data = [
        ":development_config.out",
        "//data",
    ],
    main_class = "se.tink.backend.aggregation.AggregationServiceContainer",
    visibility = ["//visibility:public"],
    runtime_deps = [
        "//src/aggregation/service",
        "//src/libraries/console_json_logger",
        "@aggregation//:mysql_mysql_connector_java",
    ],
)

java_binary(
    name = "bin_decoupled",
    args = [
        "server",
        "$(location :decoupled_config.out)",
    ],
    data = [
        ":decoupled_config.out",
        "//data",
    ],
    main_class = "se.tink.backend.aggregation.AggregationServiceContainer",
    visibility = ["//visibility:public"],
    runtime_deps = [
        "//src/aggregation/service",
        "//src/libraries/console_json_logger",
        "@aggregation//:mysql_mysql_connector_java",
    ],
)

genrule(
    name = "bin_deploy",
    # Implicitly built, see: https://docs.bazel.build/versions/master/be/java.html#java_binary_implicit_outputs
    srcs = [":bin_deploy.jar"],
    outs = ["aggregation_service.jar"],
    cmd = "cp $(location :bin_deploy.jar) \"$(@)\"",
    tags = ["manual"],
    visibility = ["//visibility:public"],
)

container_image(
    name = "aggregation_debug_image",
    base = "@distroless_java_11//image",
    cmd = [
        "-agentlib:jdwp=transport=dt_socket,server=y,address=8000,suspend=n",
        "aggregation_service.jar",
        "server",
        "development-minikube-aggregation-server.yml",
    ],
    tags = ["manual"],
    tars = [
        ":bin_tar",
        ":data_tar",
        ":chromedriver_bin_tar",
        ":chrome_bin_tar",
        ":phantomjs_bin_tar",
    ],
    visibility = ["//visibility:public"],
    workdir = "/usr/share/tink-backend-aggregation",
)

container_image(
    name = "aggregation_decoupled_image",
    base = "@distroless_java_11//image",
    cmd = [
        "aggregation_service.jar",
        "server",
        "development-decoupled.yaml",
    ],
    layers = [
        ":chromium_deps_for_java11",
    ],
    tags = ["manual"],
    tars = [
        ":bin_tar",
        ":data_tar",
        ":cryptography_tar",
        ":config_tar",
        ":chromedriver_bin_tar",
        ":chrome_bin_tar",
        ":phantomjs_bin_tar",
    ],
    visibility = ["//visibility:public"],
    workdir = "/usr/share/tink-backend-aggregation",
)

container_image(
    name = "aggregation_system_test_image",
    base = "@distroless_java_11//image",
    cmd = [
        "aggregation_service.jar",
        "server",
        "system-test.yaml",
    ],
    layers = [
        ":chromium_deps_for_java11",
    ],
    tags = ["manual"],
    tars = [
        ":bin_tar",
        ":data_tar",
        ":cryptography_tar",
        ":system_test_config_tar",
        ":chromedriver_bin_tar",
        ":chrome_bin_tar",
        ":phantomjs_bin_tar",
    ],
    visibility = ["//visibility:public"],
    workdir = "/usr/share/tink-backend-aggregation",
)

templated_file(
    name = "development_config",
    template = "development-minikube.yaml",
)

templated_file(
    name = "decoupled_config",
    template = "development-decoupled.yaml",
)

templated_file(
    name = "system_test_config",
    template = "system-test.yaml",
)

pkg_tar(
    name = "data_tar",
    srcs = ["//data"],
    mode = "0444",
    package_dir = "/usr/share/tink-backend-aggregation/data",
    strip_prefix = "/data",
    tags = ["manual"],
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "cryptography_tar",
    srcs = ["//data:cryptography_all_files"],
    mode = "0444",
    package_dir = "/usr/share/tink-backend-aggregation/data",
    strip_prefix = "/data",
    tags = ["manual"],
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "bin_tar",
    srcs = [":bin_deploy"],
    mode = "0444",
    package_dir = "/usr/share/tink-backend-aggregation",
    tags = ["manual"],
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "config_tar",
    srcs = [":development-decoupled.yaml"],
    mode = "0444",
    package_dir = "/usr/share/tink-backend-aggregation",
    tags = ["manual"],
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "system_test_config_tar",
    srcs = [":system-test.yaml"],
    mode = "0444",
    package_dir = "/usr/share/tink-backend-aggregation",
    tags = ["manual"],
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "chromedriver_bin_tar",
    srcs = ["@chromedriver//file"],
    mode = "0555",
    package_dir = "/usr/share/tink-backend-aggregation/external/chromedriver/file",
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "chrome_bin_tar",
    srcs = ["@chromium//file"],
    mode = "0555",
    package_dir = "/usr/share/tink-backend-aggregation/external/chromium/file",
    visibility = ["//docker:__pkg__"],
)

pkg_tar(
    name = "phantomjs_bin_tar",
    srcs = ["//tools:phantomjs_linux"],
    mode = "0555",
    package_dir = "/usr/share/tink-backend-aggregation/tools",
    visibility = ["//docker:__pkg__"],
)
