{{- $agentsConfig := .Values.agents | default dict }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: agents-config
  namespace: aggregation
data:
  config.yml: |
    agentsServiceConfiguration:
      excludedDebugClusters:
        excludedClusters:
          - local-development

      {{- if $agentsConfig.mountSignatureKeyPair }}
      signatureKeyPair:
        privateKeyPath: "/etc/tink-signature-key/private_rsa_key.pem"
        publicKeyPath: "/etc/tink-signature-key/public_rsa_key.pem"
      {{- end }}

      {{- if $agentsConfig.mountCallbackJwtSignaturePair }}
      callbackJwtSignatureKeyPair:
        privateKeyPath: "/etc/tink-callback-jwt-signature-pair/private_ec_key.pem"
        publicKeyPath: "/etc/tink-callback-jwt-signature-pair/public_ec_key.pem"
        isEnabled: {{ $agentsConfig.callbackJwtSignatureKeyPairEnabled | default false }}
      {{- end }}

      creditsafe:
        username: CREDITSAFE_USERNAME
        password: CREDITSAFE_PASSWORD
        logConsumerMonitoringTraffic: true

      {{- if $agentsConfig.collectorSubscriptionKey }}
      aggregationWorker:
        collectorSubscriptionKey: COLLECTOR_SUBSCRIPTION_KEY
      {{- end }}

      integrations:
        sbab:
          signBaseUrl: https://secure.sbab.se
        ukOpenBankingJson: |
          UKOPENBANKINGJSON

        {{- if $agentsConfig.proxyUri }}
        proxyUri: "{{ $agentsConfig.proxyUri }}"
        {{- end }}

        {{- if $agentsConfig.proxyUris }}
        proxyUris:
        {{- range $uri := $agentsConfig.proxyUris }}
          - "{{ $uri }}"
        {{- end }}
        {{- end }}

        {{- if $agentsConfig.monzo }}
        monzo:
          tink:
            clientId: "MONZO_CLIENT_ID"
            clientSecret: "MONZO_CLIENT_SECRET"
            redirectUrl: "{{ $agentsConfig.monzo.redirectUrl }}"
        {{- end }}

        {{- if $agentsConfig.starling }}
        starling:
          tink:
            aisConfiguration:
              clientId: "STARLING_AIS_CLIENT_ID"
              clientSecret: "STARLING_AIS_CLIENT_SECRET"
              redirectUrl: "{{ $agentsConfig.starling.redirectUrl }}"
            pisConfiguration:
              clientId: "STARLING_PIS_CLIENT_ID"
              clientSecret: "STARLING_PIS_CLIENT_SECRET"
              redirectUrl: "{{ $agentsConfig.starling.redirectUrl }}"
            keyUid: "STARLING_SIGNING_KEY_UID"
            signingKey: "STARLING_SIGNING_KEY"
        {{- end }}

        {{- if eq "true" $agentsConfig.volksbank.enabled }}
        volksbank:
          tink:
            aisConfiguration:
              clientId: "VOLKSBANK_AIS_CLIENT_ID_TAG"
              clientSecret: "VOLKSBANK_AIS_CLIENT_SECRET_TAG"
              clientCertificateContent: "VOLKSBANK_AIS_CERT_TAG"
              clientCertificatePass: "VOLKSBANK_AIS_CERT_PASSWORD_TAG"
              redirectUrl: "{{ $agentsConfig.volksbank.redirectUrl }}"
        {{- end }}

        {{- if $agentsConfig.fints }}
        fints:
          regNumber: "FINTS_REG_NUMBER"
        {{- end }}

        {{- if $agentsConfig.bunq }}
        bunq:
          tink:
            clientId: "BUNQ_CLIENT_ID_TINK_TAG"
            clientSecret: "BUNQ_CLIENT_SECRET_TINK_TAG"
            psd2ApiKey: "BUNQ_PSD2_API_KEY_TINK_TAG"
            psd2ClientAuthToken: 'BUNQ_PSD2_CLIENT_AUTH_TOKEN_TINK_TAG'
            psd2InstallationKeyPair: 'BUNQ_PSD2_INSTALLATION_KEY_PAIR_TINK_TAG'
            redirectUrl: "{{ $agentsConfig.bunq.tink.redirectUrl }}"
          abn:
            clientId: "BUNQ_CLIENT_ID_ABN_TAG"
            clientSecret: "BUNQ_CLIENT_SECRET_ABN_TAG"
            psd2ApiKey: "BUNQ_PSD2_API_KEY_ABN_TAG"
            psd2ClientAuthToken: 'BUNQ_PSD2_CLIENT_AUTH_TOKEN_ABN_TAG'
            psd2InstallationKeyPair: 'BUNQ_PSD2_INSTALLATION_KEY_PAIR_ABN_TAG'
            redirectUrl: "{{ $agentsConfig.bunq.abn.redirectUrl }}"
        {{- end }}

        {{- if $agentsConfig.rabobank }}
        rabobank:
          tink-sandbox:
            clientId: "RABOBANK_CLIENT_ID_ABN_SANDBOX_TAG"
            clientSecret: "RABOBANK_CLIENT_SECRET_ABN_SANDBOX_TAG"
            redirectUrl: "{{ $agentsConfig.rabobank.abn_sandbox.redirectUrl }}"
            baseUrl: "https://api-sandbox.rabobank.nl/openapi/sandbox"
            clientSSLP12: "RABOBANK_CERTIFICATE_P12_ABN_SANDBOX_TAG"
            clientSSLKeyPassword: "RABOBANK_CERTIFICATE_PASSWORD_ABN_SANDBOX_TAG"
            qsealc: "RABOBANK_QSEALC_ABN_TAG"
          tink:
            clientId: "RABOBANK_CLIENT_ID_ABN_TAG"
            clientSecret: "RABOBANK_CLIENT_SECRET_ABN_TAG"
            redirectUrl: "{{ $agentsConfig.rabobank.abn.redirectUrl }}"
            baseUrl: "https://api.rabobank.nl/openapi"
            clientSSLP12: "RABOBANK_CERTIFICATE_P12_ABN_TAG"
            clientSSLKeyPassword: "RABOBANK_CERTIFICATE_PASSWORD_ABN_TAG"
            qsealc: "RABOBANK_QSEALC_ABN_TAG"
          abn_sandbox:
            clientId: "RABOBANK_CLIENT_ID_ABN_SANDBOX_TAG"
            clientSecret: "RABOBANK_CLIENT_SECRET_ABN_SANDBOX_TAG"
            redirectUrl: "{{ $agentsConfig.rabobank.abn_sandbox.redirectUrl }}"
            baseUrl: "https://api-sandbox.rabobank.nl/openapi/sandbox"
            clientSSLP12: "RABOBANK_CERTIFICATE_P12_ABN_SANDBOX_TAG"
            clientSSLKeyPassword: "RABOBANK_CERTIFICATE_PASSWORD_ABN_SANDBOX_TAG"
            qsealc: "RABOBANK_QSEALC_ABN_TAG"
          abn:
            clientId: "RABOBANK_CLIENT_ID_ABN_TAG"
            clientSecret: "RABOBANK_CLIENT_SECRET_ABN_TAG"
            redirectUrl: "{{ $agentsConfig.rabobank.abn.redirectUrl }}"
            baseUrl: "https://api.rabobank.nl/openapi"
            clientSSLP12: "RABOBANK_CERTIFICATE_P12_ABN_TAG"
            clientSSLKeyPassword: "RABOBANK_CERTIFICATE_PASSWORD_ABN_TAG"
            qsealc: "RABOBANK_QSEALC_ABN_TAG"
        {{- end }}

        {{- if $agentsConfig.abnamro }}
        abnamro:
          tink:
            clientId: "ABN_AMRO_CLIENT_ID"
            clientSecret: "ABN_AMRO_CLIENT_SECRET"
            redirectUrl: "{{ $agentsConfig.abnamro.redirectUrl }}"
            clientSSLP12: "ABN_AMRO_CLIENT_SSL_P12"
            clientSSLKeyPassword: "ABN_AMRO_CLIENT_SSL_KEY_PASSWORD"
        {{- end }}

        {{- if $agentsConfig.icsConfiguration }}
        icsConfiguration:
          abn:
            clientId: "ICS_CLIENT_ID"
            clientSecret: "ICS_CLIENT_SECRET"
            clientSSLCertificate: "ICS_CLIENT_SSL_CERT"
            rootCACertificate: "ICS_CA_CERT"
            rootCAPassword: "ICS_ROOT_CA_PASSWORD"
        {{- end }}

        {{- if $agentsConfig.demoFinancialInstitution }}
        demoFinancialInstitution:
          mobilebanking:
            baseUrl: "{{ $agentsConfig.demoFinancialInstitution.baseUrl }}/mobilebanking"
          openbanking:
            baseUrl: "{{ $agentsConfig.demoFinancialInstitution.baseUrl }}/openbanking"
        {{- end }}

      abnAmro:

      {{- if $agentsConfig.abnAmro }}
      {{- range $name, $env := dict "abnAmroProduction" "production" "abnAmroStaging" "staging" }}
      {{- $envConfig := index $agentsConfig.abnAmro $env }}
      {{ $name }}:

        {{- if kindIs "bool" $envConfig.ignoreCreditCardErrors }}
        ignoreCreditCardErrors: {{ $envConfig.ignoreCreditCardErrors}}
        {{- else }}
        ignoreCreditCardErrors: true
        {{- end }}

        {{- if kindIs "bool" $envConfig.cleanBankId }}
        cleanBankId: {{ $envConfig.cleanBankId}}
        {{- else }}
        cleanBankId: false
        {{- end }}

        trustStore:
          path: data/security/abnamro.truststore
          password: changeme

        internetBanking:
          host: ABN_{{ $env | upper }}_BANKING_HOST
          authorizationToken: ABN_{{ $env | upper }}_BANKING_AUTH_TOKEN

          products:
            creditCards:
            groups:
            - CREDIT_CARDS_PRIVATE_AND_RETAIL
            - PAYMENT_SERVICES
            ids:
            - 129
          payments:
            groups:
            - PAYMENT_ACCOUNTS
            ids:
            - 13
            - 25
          savings:
            groups:
            - SAVINGS_ACCOUNTS
            ids:
            - 5
            - 8
        enrollment:
          url: ABN_{{ $env | upper }}_ENROLLMENT_URL
          apiKey: ABN_{{ $env | upper }}_ENROLLMENT_API_KEY
      {{- end }}
      {{- end }}
