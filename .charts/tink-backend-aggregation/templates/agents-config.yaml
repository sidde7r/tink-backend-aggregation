{{- $agentsConfig := .Values.agents | default dict }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: agents-config
  namespace: aggregation
data:
  config.yml: |
    agentServiceConfiguration:
      excludedDebugClusters:
        excludedClusters:
          - local-development

      signatureKeyPair:
        {{- $signatureKeyPath := ($agentsConfig.mountSignatureKeyPair | default false) | ternary "/etc/tink-signature-key" "data/test/cryptography" }}
        privateKeyPath: "{{ $signatureKeyPath }}/private_rsa_key.pem"
        publicKeyPath: "{{ $signatureKeyPath }}/public_rsa_key.pem"

      creditsafe:
        username: CREDITSAFE_USERNAME
        password: CREDITSAFE_PASSWORD
        logConsumerMonitoringTraffic: true

      {{- if $agentsConfig.collectorSubscriptionKey }}
      aggregationWorker:
        collectorSubscriptionKey: COLLECTOR_SUBSCRIPTION_KEY
      {{- end }}

      integrations:
        sbab:
          signBaseUrl: https://secure.sbab.se
        ukOpenBankingJson: UKOPENBANKINGJSON

        {{- if $agentsConfig.proxyUri }}
        proxyUri: "{{ $agentsConfig.proxyUri }}"
        {{- end }}

        {{- if $agentsConfig.monzo }}
        monzo:
          tink:
            clientId: "MONZO_CLIENT_ID"
            clientSecret: "MONZO_CLIENT_SECRET"
            redirectUrl: "{{ $agentsConfig.monzo.redirectUrl }}"
        {{- end }}

        {{- if $agentsConfig.fints }}
        fints:
          regNumber: "FINTS_REG_NUMBER"
        {{- end }}

        {{- if $agentsConfig.abnAmro }}
        {{- range $name, $env := dict "abnAmroProduction" "production" "abnAmroStaging" "staging" }}
        {{- $envConfig := index $agentsConfig.abnAmro $env }}
        {{ $name }}:

          {{- if kindIs "bool" $envConfig.ignoreCreditCardErrors }}
          ignoreCreditCardErrors: {{ $envConfig.ignoreCreditCardErrors}}
          {{- else }}
          ignoreCreditCardErrors: true
          {{- end }}

          {{- if kindIs "bool" $envConfig.cleanBankId }}
          cleanBankId: {{ $envConfig.cleanBankId}}
          {{- else }}
          cleanBankId: false
          {{- end }}

          trustStore:
            path: data/security/abnamro.truststore
            password: changeme

          internetBanking:
            host: ABN_{{ $env | upper }}_BANKING_HOST
            authorizationToken: ABN_{{ $env | upper }}_BANKING_AUTH_TOKEN

            products:
              creditCards:
              groups:
              - CREDIT_CARDS_PRIVATE_AND_RETAIL
              - PAYMENT_SERVICES
              ids:
              - 129
            payments:
              groups:
              - PAYMENT_ACCOUNTS
              ids:
              - 13
              - 25
            savings:
              groups:
              - SAVINGS_ACCOUNTS
              ids:
              - 5
              - 8
          enrollment:
            url: ABN_{{ $env | upper }}_ENROLLMENT_URL
            apiKey: ABN_{{ $env | upper }}_ENROLLMENT_API_KEY
        {{- end }}
        {{- end }}
