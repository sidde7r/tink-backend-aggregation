{{- $agentsConfig := .Values.agents | default dict }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-scripts
  namespace: aggregation
data:
  add-secrets.sh: |
    #!/bin/bash -e

    cp /mnt/aggregation-config/* /mnt/altered-config-volume
    echo -e '\n' >> /mnt/altered-config-volume/config.yml
    cat /mnt/agents-config/config.yml >> /mnt/altered-config-volume/config.yml

    function substitute-secret() {
      local name="$1"
      local value="${2%$'\n'}"
      echo "Substituting secret $name"

      sed -i "s/$name/${value//\//\\\/}/g" /mnt/altered-config-volume/config.yml
    }

    substitute-secret COLLECTOR_SUBSCRIPTION_KEY "$COLLECTOR_SUBSCRIPTION_KEY"
    substitute-secret UKOPENBANKINGJSON "$UKOPENBANKINGJSON"
    substitute-secret CREDITSAFE_USERNAME "$CREDITSAFE_USERNAME"
    substitute-secret CREDITSAFE_PASSWORD "$CREDITSAFE_PASSWORD"
    substitute-secret KEYSTORE_PASSWORD "$KEYSTORE_PASSWORD"
    substitute-secret AXA_PSD2_CLIENT_ID "$AXA_PSD2_CLIENT_ID"
    substitute-secret BPOST_PSD2_CLIENT_ID "$BPOST_PSD2_CLIENT_ID"
    substitute-secret CRELAN_PSD2_CLIENT_ID "$CRELAN_PSD2_CLIENT_ID"
    substitute-secret SEB_CLIENT_ID "$SEB_CLIENT_ID"
    substitute-secret SEB_CLIENT_SECRET "$SEB_CLIENT_SECRET"
    substitute-secret MONZO_CLIENT_ID "$MONZO_CLIENT_ID"
    substitute-secret MONZO_CLIENT_SECRET "$MONZO_CLIENT_SECRET"
    substitute-secret BANKDATA_CLIENT_ID "$BANKDATA_CLIENT_ID"
    substitute-secret BANKDATA_API_KEY "$BANKDATA_API_KEY"
    substitute-secret STARLING_AIS_CLIENT_ID "$STARLING_AIS_CLIENT_ID"
    substitute-secret STARLING_AIS_CLIENT_SECRET "$STARLING_AIS_CLIENT_SECRET"
    substitute-secret STARLING_PIS_CLIENT_ID "$STARLING_PIS_CLIENT_ID"
    substitute-secret STARLING_PIS_CLIENT_SECRET "$STARLING_PIS_CLIENT_SECRET"
    substitute-secret STARLING_SIGNING_KEY_UID "$STARLING_SIGNING_KEY_UID"
    substitute-secret STARLING_SIGNING_KEY "$STARLING_SIGNING_KEY"
    substitute-secret FINTS_REG_NUMBER "$FINTS_REG_NUMBER"
    substitute-secret ABN_STAGING_BANKING_HOST "$ABN_STAGING_BANKING_HOST"
    substitute-secret ABN_STAGING_BANKING_AUTH_TOKEN "$ABN_STAGING_BANKING_AUTH_TOKEN"
    substitute-secret ABN_STAGING_ENROLLMENT_URL "$ABN_STAGING_ENROLLMENT_URL"
    substitute-secret ABN_STAGING_ENROLLMENT_API_KEY "$ABN_STAGING_ENROLLMENT_API_KEY"
    substitute-secret ABN_PRODUCTION_BANKING_HOST "$ABN_PRODUCTION_BANKING_HOST"
    substitute-secret ABN_PRODUCTION_BANKING_AUTH_TOKEN "$ABN_PRODUCTION_BANKING_AUTH_TOKEN"
    substitute-secret ABN_PRODUCTION_ENROLLMENT_URL "$ABN_PRODUCTION_ENROLLMENT_URL"
    substitute-secret ABN_PRODUCTION_ENROLLMENT_API_KEY "$ABN_PRODUCTION_ENROLLMENT_API_KEY"
    substitute-secret MYSQL_PASSWORD "$MYSQL_PASSWORD"
    substitute-secret ICS_CLIENT_ID "$ICS_CLIENT_ID"
    substitute-secret ICS_CLIENT_SECRET "$ICS_CLIENT_SECRET"
    substitute-secret ICS_CLIENT_SSL_CERT "$ICS_CLIENT_SSL_CERT"
    substitute-secret ICS_CA_CERT "$ICS_CA_CERT"
    substitute-secret ICS_ROOT_CA_PASSWORD "$ICS_ROOT_CA_PASSWORD"
    substitute-secret RABOBANK_CLIENT_ID_TINK_SANDBOX_TAG "$RABOBANK_CLIENT_ID_TINK_SANDBOX"
    substitute-secret RABOBANK_CLIENT_SECRET_TINK_SANDBOX_TAG "$RABOBANK_CLIENT_SECRET_TINK_SANDBOX"
    substitute-secret RABOBANK_CERTIFICATE_P12_TINK_SANDBOX_TAG "$RABOBANK_CERTIFICATE_P12_TINK_SANDBOX"
    substitute-secret RABOBANK_CLIENT_ID_TINK_TAG "$RABOBANK_CLIENT_ID_TINK"
    substitute-secret RABOBANK_CLIENT_SECRET_TINK_TAG "$RABOBANK_CLIENT_SECRET_TINK"
    substitute-secret RABOBANK_CERTIFICATE_P12_TINK_TAG "$RABOBANK_CERTIFICATE_P12_TINK"
    substitute-secret RABOBANK_QSEALC_TINK_TAG "$RABOBANK_QSEALC_TINK"
    substitute-secret RABOBANK_CLIENT_ID_ABN_SANDBOX_TAG "$RABOBANK_CLIENT_ID_ABN_SANDBOX"
    substitute-secret RABOBANK_CLIENT_SECRET_ABN_SANDBOX_TAG "$RABOBANK_CLIENT_SECRET_ABN_SANDBOX"
    substitute-secret RABOBANK_CERTIFICATE_P12_ABN_SANDBOX_TAG "$RABOBANK_CERTIFICATE_P12_ABN_SANDBOX"
    substitute-secret RABOBANK_CLIENT_ID_ABN_TAG "$RABOBANK_CLIENT_ID_ABN"
    substitute-secret RABOBANK_CLIENT_SECRET_ABN_TAG "$RABOBANK_CLIENT_SECRET_ABN"
    substitute-secret RABOBANK_CERTIFICATE_P12_ABN_TAG "$RABOBANK_CERTIFICATE_P12_ABN"
    substitute-secret RABOBANK_QSEALC_ABN_TAG "$RABOBANK_QSEALC_ABN"
    substitute-secret REDSYS_CLIENT_ID_TAG "$REDSYS_CLIENT_ID"
    substitute-secret REDSYS_QSEALC_TAG "$REDSYS_QSEALC"
    substitute-secret ABN_AMRO_CLIENT_ID_TINK_TAG "$ABN_AMRO_CLIENT_ID_TINK"
    substitute-secret ABN_AMRO_API_KEY_TINK_TAG "$ABN_AMRO_API_KEY_TINK"
    substitute-secret ABN_AMRO_CLIENT_SSL_P12_TINK_TAG "$ABN_AMRO_CLIENT_SSL_P12_TINK"
    substitute-secret ABN_AMRO_CLIENT_SSL_KEY_PASSWORD_TINK_TAG "$ABN_AMRO_CLIENT_SSL_KEY_PASSWORD_TINK"
    substitute-secret SIBS_CLIENT_ID_TINK_TAG "$SIBS_CLIENT_ID_TINK"
    substitute-secret SIBS_CLIENT_SECRET_TINK_TAG "$SIBS_CLIENT_SECRET_TINK"
    substitute-secret SIBS_CERTIFICATE_P12_TINK_TAG "$SIBS_CERTIFICATE_P12_TINK"
    substitute-secret SIBS_CERTIFICATE_SERIAL_NUMBER_TINK_TAG "$SIBS_CERTIFICATE_SERIAL_NUMBER_TINK"
    substitute-secret SIBS_CLIENT_ID_CGD_TAG "$SIBS_CLIENT_ID_CGD"
    substitute-secret SIBS_CLIENT_SECRET_CGD_TAG "$SIBS_CLIENT_SECRET_CGD"
    substitute-secret SIBS_CERTIFICATE_P12_CGD_TAG "$SIBS_CERTIFICATE_P12_CGD"
    substitute-secret SIBS_CERTIFICATE_SERIAL_NUMBER_CGD_TAG "$SIBS_CERTIFICATE_SERIAL_NUMBER_CGD"
    substitute-secret VOLKSBANK_AIS_CLIENT_ID_TINK_TAG "$VOLKSBANK_AIS_CLIENT_ID_TINK"
    substitute-secret VOLKSBANK_AIS_CLIENT_SECRET_TINK_TAG "$VOLKSBANK_AIS_CLIENT_SECRET_TINK"
    substitute-secret VOLKSBANK_AIS_CLIENT_ID_ABN_TAG "$VOLKSBANK_AIS_CLIENT_ID_ABN"
    substitute-secret VOLKSBANK_AIS_CLIENT_SECRET_ABN_TAG "$VOLKSBANK_AIS_CLIENT_SECRET_ABN"
    substitute-secret CIC_CLIENT_ID_TAG "$CIC_CLIENT_ID"
    substitute-secret CMCIC_KEY_ID_TAG "$CMCIC_KEY_ID"
    substitute-secret CREDITMUTUEL_CLIENT_ID_TAG "$CREDITMUTUEL_CLIENT_ID"
    substitute-secret COMDIRECT_CLIENT_ID_TAG "$COMDIRECT_CLIENT_ID"
    substitute-secret COMMERZBANK_CLIENT_ID_TAG "$COMMERZBANK_CLIENT_ID"
    substitute-secret SWEDBANK_CLIENT_ID "$SWEDBANK_CLIENT_ID"
    substitute-secret SWEDBANK_CLIENT_SECRET "$SWEDBANK_CLIENT_SECRET"
    substitute-secret CBI_CLIENT_ID_TINK_TAG "$CBI_CLIENT_ID"
    substitute-secret CBI_CLIENT_SECRET_TINK_TAG "$CBI_CLIENT_SECRET"
    substitute-secret SPAREBANK_CERTIFICATE "$SPAREBANK_CERTIFICATE"
    substitute-secret SPAREBANK_KEY_ID "$SPAREBANK_KEY_ID"
    substitute-secret SPAREBANK_TPP_ID "$SPAREBANK_TPP_ID"
    substitute-secret BEC_QSEALC "$BEC_QSEALC"
    substitute-secret BEC_KEY_ID "$BEC_KEY_ID"
    substitute-secret HANDELSBANKEN_TPP_ID_TAG "$HANDELSBANKEN_TPP_ID"
    substitute-secret HANDELSBANKEN_CLIENT_ID_TAG "$HANDELSBANKEN_CLIENT_ID"
    substitute-secret BELFIUS_CLIENT_ID_TAG "$BELFIUS_CLIENT_ID"
    substitute-secret BELFIUS_CLIENT_SECRET_TAG "$BELFIUS_CLIENT_SECRET"
    substitute-secret CROSSKEY_CLIENT_ID_TAG "$CROSSKEY_CLIENT_ID"
    substitute-secret CROSSKEY_CLIENT_SECRET_TAG "$CROSSKEY_CLIENT_SECRET"
    substitute-secret FINECOBANK_CLIENT_ID_TAG "$FINECOBANK_CLIENT_ID"
    substitute-secret ING_CERTIFICATE_SERIAL_NUMBER_TINK_TAG "$ING_CERTIFICATE_SERIAL_NUMBER_TINK"
    substitute-secret ING_CERTIFICATE_P12_TINK_TAG "$ING_CERTIFICATE_P12_TINK"
    substitute-secret ING_CERTIFICATE_SERIAL_NUMBER_ABN_TAG "$ING_CERTIFICATE_SERIAL_NUMBER_ABN"
    substitute-secret ING_CERTIFICATE_P12_ABN_TAG "$ING_CERTIFICATE_P12_ABN"
