kind: RuleGroup
apiVersion: monitoring.tink.se/v1
metadata:
  name: alerts-payments-it
  namespace: agents
spec:
  interval: 2m30s
  rules:

  #-------------------------------------------------------------------------------------------------------------------
  # Payment failed alerts
  #-------------------------------------------------------------------------------------------------------------------
  - alert: it_payment_failed_rate_over_80%
    expr: 0.8 <= IT:agent_transfer:className:failed:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 5)
    for: 10m
    labels:
      severity: urgent
      priority: P1
      who: connectivity-nazguls
    annotations:
      description: Failed outcome is when rejected by bank, agent threw generic payment exception or any unhandled exception, etc
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 5 attempts, active for at least 10 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}
  
  - alert: it_payment_failed_rate_between_60%_and_80%
    expr: 0.6 <= IT:agent_transfer:className:failed:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 5) < 0.8
    for: 15m
    labels:
      severity: urgent
      priority: P2
      who: connectivity-nazguls
    annotations:
      description: Failed outcome is when rejected by bank, agent threw generic payment exception or any unhandled exception, etc
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 5 attempts, active for at least 15 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}

  - alert: it_payment_failed_rate_between_40%_and_60%
    expr: 0.4 <= IT:agent_transfer:className:failed:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 5) < 0.6
    for: 20m
    labels:
      severity: ping
      priority: P3
      who: connectivity-nazguls
    annotations:
      description: Failed outcome is when rejected by bank, agent threw generic payment exception or any unhandled exception, etc
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 5 attempts, active for at least 20 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}

  #-------------------------------------------------------------------------------------------------------------------
  # Bank side errors alerts
  #-------------------------------------------------------------------------------------------------------------------
  - alert: it_payment_unavailable_rate_over_80%
    expr: 0.8 < IT:agent_transfer:className:unavailable:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 5)
    for: 20m
    labels:
      severity: urgent
      priority: P1
      who: connectivity-nazguls
    annotations:
      description: Unavailable outcome is when agent throws BankServiceException
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 5 attempts, active for at least 20 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}

  - alert: it_payment_unavailable_rate_between_40%_and_80%
    expr: 0.4 < IT:agent_transfer:className:unavailable:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 5) < 0.8
    for: 20m
    labels:
      severity: ping
      priority: P3
      who: connectivity-nazguls
    annotations:
      description: Unavailable outcome is when agent throws BankServiceException
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 5 attempts, active for at least 20 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}

  #-------------------------------------------------------------------------------------------------------------------
  # Authentication errors and cancelled payments alerts
  #-------------------------------------------------------------------------------------------------------------------
  - alert: it_payment_cancelled_rate_over_80%
    expr: 0.8 < IT:agent_transfer:className:cancelled:delta1h / (IT:agent_transfer:className:all_payments:delta1h > 10)
    for: 20m
    labels:
      severity: ping
      priority: P3
      who: connectivity-nazguls
    annotations:
      description: Cancelled outcome is when auth fails, or payment doesn't pass validation
      summary: |
        Error rate: <{ $value | humanizePercentage }>
        Class: <{ $labels.className }>
        Checking last hour, with at least 10 attempts, active for at least 20 min.
        <{{ .Values.kibanaClassLinkAbs1h }} |Kibana>
        <{{ .Values.grafanaClassLinkAbs1h }} |Grafana>
      tags: {{ .Values.tags }}
