kind: RuleGroup
apiVersion: monitoring.tink.se/v1
metadata:
  name: alerts
  namespace: agents
spec:
  rules:
### Market specific alerts for degrading logins and refreshes
### Keep them market separate since we might want to tweak the attempt limits
### depending on how much traffic we have on each market.
    # SE
  - alert: LoginSuccessRateLowWithAttemptLimitSE
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="SE"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitSE
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="SE"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="SE"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="SE"}[30m])) by (className) > 30
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

      # BE
  - alert: LoginSuccessRateLowWithAttemptLimitBE
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="BE"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="BE"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="BE"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitBE
    expr: |
      # Successful attempts above 95%
      (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="BE"}[30m])) by (className)
          / sum(increase(tink_agent_refresh_total{market="BE"}[30m])) by (className) < 0.95)
      # At least this many attempts.
      and sum(increase(tink_agent_refresh_total{market="BE"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # GB
  - alert: LoginSuccessRateLowWithAttemptLimitGB
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="GB"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="GB"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="GB"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitGB
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="GB"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="GB"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="GB"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # AT
  - alert: LoginSuccessRateLowWithAttemptLimitAT
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="AT"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="AT"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="AT"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitAT
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="AT"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="AT"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="AT"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # DE
  - alert: LoginSuccessRateLowWithAttemptLimitDE
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="DE"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="DE"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="DE"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitDE
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="DE"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="DE"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="DE"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # DK
  - alert: LoginSuccessRateLowWithAttemptLimitDK
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="DK"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="DK"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="DK"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitDK
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="DK"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="DK"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="DK"}[30m])) by (className) > 5
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

      # EE
  - alert: LoginSuccessRateLowWithAttemptLimitEE
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="EE"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="EE"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="EE"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitEE
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="EE"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="EE"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="EE"}[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

        # ES
  - alert: LoginSuccessRateLowWithAttemptLimitES
    expr: |
       # Successful/Cancelled attempts above 95%
       (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="ES"}[30m])) by (action,className)
           / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="ES"}[30m])) by (action,className) < 0.95)
       # At least this many attempts.
       and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="ES"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitES
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="ES"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="ES"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="ES"}[30m])) by (className) > 8
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

      # FI
  - alert: LoginSuccessRateLowWithAttemptLimitFI
    expr: |
       # Successful/Cancelled attempts above 95%
       (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="FI"}[30m])) by (action,className)
           / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="FI"}[30m])) by (action,className) < 0.95)
       # At least this many attempts.
       and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="FI"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitFI
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="FI"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="FI"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="FI"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # FR
  - alert: LoginSuccessRateLowWithAttemptLimitFR
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="FR"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="FR"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="FR"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitFR
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="FR"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="FR"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="FR"}[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

      # NL
  - alert: LoginSuccessRateLowWithAttemptLimitNL
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="NL"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NL"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NL"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitNL
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="NL"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="NL"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="NL"}[30m])) by (className) > 20
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # NO
  - alert: LoginSuccessRateLowWithAttemptLimitNO
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="NO"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NO"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NO"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitNO
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="NO"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="NO"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="NO"}[30m])) by (className) > 10
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # BG
  - alert: LoginSuccessRateLowWithAttemptLimitBG
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="BG"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="BG"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="BG"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitBG
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="BG"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="BG"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="BG"}[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # CA
  - alert: LoginSuccessRateLowWithAttemptLimitCA
    expr: |
       # Successful/Cancelled attempts above 95%
       (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="CA"}[30m])) by (action,className)
           / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="CA"}[30m])) by (action,className) < 0.95)
       # At least this many attempts.
       and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="CA"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitCA
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="CA"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="CA"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="CA"}[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
                Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

    # RO
  - alert: LoginSuccessRateLowWithAttemptLimitRO
    expr: |
        # Successful/Cancelled attempts above 95%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="RO"}[30m])) by (action,className)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="RO"}[30m])) by (action,className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="RO"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: RefreshSuccessRateLowWithAttemptLimitRO
    expr: |
        # Successful attempts above 95%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="RO"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total{market="RO"}[30m])) by (className) < 0.95)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="RO"}[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh success rate is below 95% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh success rate is below 95% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: BankServerUnavailableForLogin
    expr: |
       # Unavailable outcome above 10%
       (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"unavailable"}[30m])) by (action,className)
           / sum(increase(tink_agent_login_total{action=~"login|is-logged-in"}[30m])) by (action,className) > 0.05)
       # At least this many attempts.
       and sum(increase(tink_agent_login_total{action=~"login|is-logged-in"}[30m])) by (action,className) > 2
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Login unavailable rate is above 10% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Login unavailable rate is above 10% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

  - alert: BankServerUnavailableForRefresh
    expr: |
        # Unavailable outcome above 10%
        (sum(increase(tink_agent_refresh_total{outcome=~"unavailable"}[30m])) by (className)
            / sum(increase(tink_agent_refresh_total[30m])) by (className) > 0.05)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total[30m])) by (className) > 1
    for: 5m
    labels:
        severity: ping
        who: '#integration-oncall'
    annotations:
        description: Refresh unavailable rate is above 10% ( <{ $value }> ) for the last 30 minutes.
            Investigate immediately.
        summary: Refresh unavailable rate is above 10% ( <{ $value }> ) for <{ $labels.className }>
            the last 30 minutes.
        tags: <{ $labels.className }>

### Too many errors in general
    # Alert based on the 5m rate of log-lines from logback (used in tink-backend).
    # Threshold: old canonical threshold of 20 errors / 15 min.
  - alert: TooManyLoggedIntegrationErrors
    expr: sum(rate(logback_appender_total{job="tink-aggregation",at=~"^(?:se.tink.backend.aggregation.nxgen.*)$|^(?:se.tink.backend.aggregation.agents.*)$",level="error"}[5m]))
      BY (at, job) * 15 * 60 > 20
    for: 15m
    labels:
      severity: urgent
      who: integration
    annotations:
      description: Job <{ $labels.job }> has logged <{ $value }> errors past 15m in class
        '<{ $labels.at }>'.
      summary: Too many errors logged by <{ $labels.job }>

### Agent level login failures
  - alert: HighProviderFailedLoginRatio
    expr: |
      # Never trigger on agents with less than 40 login attempts past 60 minutes.
      # This filters out small agents which are less critical to fix quickly
      sum(increase(tink_agent_login_total{action="login"}[1h])) BY (className) > 40 and
      # Agents where more than 20% of the login attempts fail.
      sum(increase(tink_agent_login_total{action="login",outcome="failed"}[30m])) BY (className) / sum(increase(tink_agent_login_total{action="login"}[30m])) BY (className) > 0.20
    for: 30m
    labels:
      severity: urgent
      who: integration
    annotations:
      description: To learn more check out the metric `tink_agent_login_total`. This
        alert never triggers on agents that did less than 10 operations in the
        past 60 minutes.
      summary: Agent <{ $labels.className }> has failed over 20%
        of its login attempts the past 60 minutes.

### Provider level fails
  - alert: HighProviderErrorRatio
    expr: |
      # Never triggers on providers that did less than 10 operations past 60
      # minutes. This filters out small providers which are less critical to fix
      # quickly.
      sum(increase(tink_executions_total[1h])) BY (provider) > 10 and
      # Providers where over 50% of the requests have failed.
      ratio:tink_provider_errors:delta60m > 50
    for: 15m
    labels:
      severity: ping
      who: '#integration-oncall'
    annotations:
      description: Investigate further in https://kibana.global.tink.network/goto/e0e04ba547d2d76936afa0788febabc8
        (and possibly add the provider in search query). This alert never triggers
        on providers that did less than 10 operations past 60 minutes.
      summary: Provider <{ $labels.provider }> has failed over 50%
        of its operations the past 60 minutes

### Not able to refresh certain refreshable items
  - alert: ProviderNotAbleToFetchCheckingAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_checking_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_checking_accounts_fetched:delta1w < 0.2
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No checking accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 80% of users used to have checking accounts.
      summary: No checking accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchSavingAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_savings_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_savings_accounts_fetched:delta1w < 0.8
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No savings accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 20% of users used to have saving accounts.
      summary: No savings accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchCreditCardAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_creditcards_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_creditcards_accounts_fetched:delta1w < 0.85
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No credit card accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have credit card accounts.
      summary: No credit card accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchInvestmentAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_investment_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_investment_accounts_fetched:delta1w < 0.9
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No investment accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have investment accounts.
      summary: No investment card accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchLoanAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_loan_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_loan_accounts_fetched:delta1w < 0.9
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No loan accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have loan accounts.
      summary: No loan card accounts fetched for <{ $labels.provider }>
        for 2 hours.

### Precomputations.
    # Calculate the ratio of not fetching any accounts (with certain type)
    # over certain interval of time.
  - record: ratio:tink_no_checking_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="CHECKING"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)
  - record: ratio:tink_no_savings_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="SAVINGS"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_creditcards_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="CREDIT_CARD"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_investment_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="INVESTMENT"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_loan_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="LOAN"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

    # Calculate the the ration of provider errors (without authentication errors).
  - record: ratio:tink_provider_errors:delta60m
    expr: 100 * ((sum(increase(tink_temporary_errors_total[1h])) BY (provider)) /
      (sum(increase(tink_executions_total[1h])) BY (provider)))
