kind: RuleGroup
apiVersion: monitoring.tink.se/v1
metadata:
  name: alerts
  namespace: agents
spec:
  rules:

  # All Markets.
  # For metrics that lack market properties.

  - alert: TransferSuccessRateLow
    expr: |
      # Successful/Cancelled/Unavailable transfer outcomes below 50%
      (sum by(provider) (increase(tink_agent_transfer_total{provider_type!="test", outcome=~"completed|cancelled|unavailable"}[1h]))
        / sum by(provider) (increase(tink_agent_transfer_total{provider_type!="test"}[1h]))) < 0.5
      # # At least this many attempts
      and sum by(provider) (increase(tink_agent_transfer_total{provider_type!="test"}[1h])) > 5
    for: 5m
    labels:
        severity: urgent
        priority: P3
        who: payments
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Transfer success rate is below 50% actual % is <{ $value }> for <{ $labels.className }> ( <{ $labels.provider }> )
          the last 1h. More than 5 attempts.
        tags: <{ $labels.provider }> , *#payments*

### Market specific alerts for degrading logins and refreshes
### Keep them market separate since we might want to tweak the attempt limits
### depending on how much traffic we have on each market.
    # SE - without Danske bank as it has known issues that often puts it below 90 %. See
    # LoginSuccessRateLowWithAttemptLimitDanskebank below.
  - alert: LoginSuccessRateLowWithAttemptLimitSE
    expr: |
        # Successful/Cancelled attempts above 85%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="SE", className!~"banks.danskebank.v2.DanskeBankV2Agent"}[60m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE", className!~"banks.danskebank.v2.DanskeBankV2Agent"}[60m])) by (action,className,provider) < 0.85)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE", className!~"banks.danskebank.v2.DanskeBankV2Agent"}[60m])) by (action,className,provider) > 10
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Login success rate is below 85% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last 60 minutes.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

  # Danske bank specific alert as the integration has issues during login that won't be resolved
  # without upgrading to nxgen agent. Has a threshold of 80% so we don't get unactionable alerts.
  - alert: LoginSuccessRateLowWithAttemptLimitDanskebank
    expr: |
        # Successful/Cancelled attempts above 80%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="SE", className="banks.danskebank.v2.DanskeBankV2Agent"}[30m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE", className="banks.danskebank.v2.DanskeBankV2Agent"}[30m])) by (action,className,provider) < 0.80)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="SE", className="banks.danskebank.v2.DanskeBankV2Agent"}[30m])) by (action,className,provider) > 10
    for: 5m
    labels:
      severity: urgent
      who: integration
    annotations:
      description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
          https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
      summary: Login success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
        the last 30 minutes.
      tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

  - alert: RefreshSuccessRateLowWithAttemptLimitSE
    expr: |
        # Successful attempts above 90%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="SE"}[30m])) by (className,provider)
            / sum(increase(tink_agent_refresh_total{market="SE"}[30m])) by (className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="SE"}[30m])) by (className,provider) > 50
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Refresh success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last 30 minutes.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

    # GB
  - alert: LoginSuccessRateLowWithAttemptLimitGB
    expr: |
        # Successful/Cancelled attempts above 85%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="GB"}[60m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="GB"}[60m])) by (action,className,provider) < 0.85)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="GB"}[60m])) by (action,className,provider) > 5
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Login success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-fluffy*

  - alert: RefreshSuccessRateLowWithAttemptLimitGB
    expr: |
        # Successful attempts above 90%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="GB"}[60m])) by (className,provider)
            / sum(increase(tink_agent_refresh_total{market="GB"}[60m])) by (className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="GB"}[60m])) by (className,provider) > 10
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Refresh success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-fluffy*

    # AT
  - alert: LoginSuccessRateLowWithAttemptLimitAT
    expr: |
        # Successful/Cancelled attempts above 90%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="AT"}[60m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="AT"}[60m])) by (action,className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="AT"}[60m])) by (action,className,provider) > 5
    for: 5m
    labels:
        severity: ping
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Login success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

  - alert: RefreshSuccessRateLowWithAttemptLimitAT
    expr: |
        # Successful attempts above 90%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="AT"}[60m])) by (className,provider)
            / sum(increase(tink_agent_refresh_total{market="AT"}[60m])) by (className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="AT"}[60m])) by (className,provider) > 10
    for: 5m
    labels:
        severity: ping
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Refresh success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

    # ES
  - alert: LoginSuccessRateLowWithAttemptLimitES
    expr: |
        # Successful/Cancelled attempts above 65%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="ES"}[60m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="ES"}[60m])) by (action,className,provider) < 0.65)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="ES"}[60m])) by (action,className,provider) > 5
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Login success rate is below 65% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

  - alert: RefreshSuccessRateLowWithAttemptLimitES
    expr: |
        # Successful attempts above 90%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="ES"}[60m])) by (className,provider)
            / sum(increase(tink_agent_refresh_total{market="ES"}[60m])) by (className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="ES"}[60m])) by (className,provider) > 10
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Refresh success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

    # NL
  - alert: LoginSuccessRateLowWithAttemptLimitNL
    expr: |
        # Successful/Cancelled attempts above 90%
        (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"completed|cancelled|unavailable", market="NL", className!~"banks.psd2.redirect.RedirectAuthenticationDemoAgent"}[60m])) by (action,className,provider)
            / sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NL"}[60m])) by (action,className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_login_total{action=~"login|is-logged-in", market="NL"}[60m])) by (action,className,provider) > 10
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Login success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last hour.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

  - alert: RefreshSuccessRateLowWithAttemptLimitNL
    expr: |
        # Successful attempts above 90%
        (sum(increase(tink_agent_refresh_total{outcome=~"completed|unavailable", market="NL"}[30m])) by (className,provider)
            / sum(increase(tink_agent_refresh_total{market="NL"}[30m])) by (className,provider) < 0.90)
        # At least this many attempts.
        and sum(increase(tink_agent_refresh_total{market="NL"}[30m])) by (className,provider) > 50
    for: 5m
    labels:
        severity: urgent
        who: integration
    annotations:
        description: https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
            https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
        summary: Refresh success rate is below 90% ( <{ $value }> ) for <{ $labels.className }> ( <{ $labels.provider }> )
            the last 30 minutes.
        tags: <{ $labels.className }> , <{ $labels.provider }> , *#aggregation-thundercats*

### Bank side failures
  - alert: BankServerUnavailableForLogin
    expr: |
      # Unavailable outcome above 50%
      (sum(increase(tink_agent_login_total{action=~"login|is-logged-in",  outcome=~"unavailable"}[30m])) by (action,className)
          / sum(increase(tink_agent_login_total{action=~"login|is-logged-in"}[30m])) by (action,className) > 0.50)
      # At least this many attempts.
      and sum(increase(tink_agent_login_total{action=~"login|is-logged-in"}[30m])) by (action,className) > 10
    for: 5m
    labels:
      severity: ping
      who: integration
    annotations:
      description: Login unavailable rate is above 50% ( <{ $value }> ) for the last 30 minutes.
        Investigate immediately.
      summary: Login unavailable rate is above 50% ( <{ $value }> ) for <{ $labels.className }>
        the last 30 minutes.
      tags: <{ $labels.className }>

  - alert: BankServerUnavailableForRefresh
    expr: |
      # Unavailable outcome above 50%
      (sum(increase(tink_agent_refresh_total{outcome=~"unavailable"}[30m])) by (className)
          / sum(increase(tink_agent_refresh_total[30m])) by (className) > 0.50)
      # At least this many attempts.
      and sum(increase(tink_agent_refresh_total[30m])) by (className) > 10
    for: 5m
    labels:
      severity: ping
      who: integration
    annotations:
      description: Refresh unavailable rate is above 50% ( <{ $value }> ) for the last 30 minutes.
        Investigate immediately.
      summary: Refresh unavailable rate is above 50% ( <{ $value }> ) for <{ $labels.className }>
        the last 30 minutes.
      tags: <{ $labels.className }>

### Agent level login failures
  - alert: HighProviderFailedLoginRatio
    expr: |
      # Never trigger on agents with less than 40 login attempts past 60 minutes.
      # This filters out small agents which are less critical to fix quickly
      sum(increase(tink_agent_login_total{action="login"}[1h])) BY (className,provider) > 40 and
      # Agents where more than 20% of the login attempts fail.
      sum(increase(tink_agent_login_total{action="login",outcome="failed"}[30m])) BY (className,provider) / sum(increase(tink_agent_login_total{action="login"}[30m])) BY (className,provider) > 0.20
    for: 30m
    labels:
      severity: urgent
      who: integration
    annotations:
      description: To learn more check out the metric `tink_agent_login_total`. This
        alert never triggers on agents that did less than 10 operations in the
        past 60 minutes.
        https://kibana.aggregation-production.tink.network/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1h,to:now))&_a=(columns:!(doc.exception,doc.message),filters:!(('$state':(store:appState),exists:(field:doc.exception),meta:(alias:!n,disabled:!f,index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',key:doc.exception,negate:!f,type:exists,value:exists))),index:'26fa2220-73b2-11e8-9a34-dbc1936ede52',interval:auto,query:(language:lucene,query:'doc.mdc.providerName:%22<{$labels.provider}>%22'),sort:!(!('@timestamp',desc)))
        https://grafana.global-production.tink.network/d/000000078/integration-dashboard?orgId=1&from=now-1h&to=now&var-cluster=aggregation&var-environment=production&var-market=All&var-agent=All&var-provider=<{$labels.provider}>&var-interval=15m&var-app=tink-backend-aggregation
      summary: Agent <{ $labels.className }> has failed over 20%
        of its login attempts the past 60 minutes.
      tags: <{ $labels.className }> , <{ $labels.provider }>

### Provider level fails
  - alert: HighProviderErrorRatio
    expr: |
      # Never triggers on providers that did less than 10 operations past 60
      # minutes. This filters out small providers which are less critical to fix
      # quickly.
      sum(increase(tink_executions_total[1h])) BY (provider) > 10 and
      # Providers where over 50% of the requests have failed.
      ratio:tink_provider_errors:delta60m > 50
    for: 15m
    labels:
      severity: ping
      who: integration
    annotations:
      description: Investigate further in https://kibana.global.tink.network/goto/e0e04ba547d2d76936afa0788febabc8
        (and possibly add the provider in search query). This alert never triggers
        on providers that did less than 10 operations past 60 minutes.
      summary: Provider <{ $labels.provider }> has failed over 50%
        of its operations the past 60 minutes

### Not able to refresh certain refreshable items
  - alert: ProviderNotAbleToFetchCheckingAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_checking_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_checking_accounts_fetched:delta1w < 0.2
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No checking accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 80% of users used to have checking accounts.
      summary: No checking accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchSavingAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_savings_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_savings_accounts_fetched:delta1w < 0.8
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No savings accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 20% of users used to have saving accounts.
      summary: No savings accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchCreditCardAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_creditcards_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_creditcards_accounts_fetched:delta1w < 0.85
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No credit card accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have credit card accounts.
      summary: No credit card accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchInvestmentAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_investment_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_investment_accounts_fetched:delta1w < 0.9
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No investment accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have investment accounts.
      summary: No investment card accounts fetched for <{ $labels.provider }>
        for 2 hours.

  - alert: ProviderNotAbleToFetchLoanAccounts
    expr: |
      sum(increase(tink_accounts_refresh_total[1h])) BY (provider) > 10 and
      ratio:tink_no_loan_accounts_fetched:delta1h > 0.99 and
      ratio:tink_no_loan_accounts_fetched:delta1w < 0.9
    for: 2h
    labels:
      severity: urgent
      who: integration
    annotations:
      description: No loan accounts fetched for <{ $labels.provider }>
        for 2 hours. Over 15% of users used to have loan accounts.
      summary: No loan card accounts fetched for <{ $labels.provider }>
        for 2 hours.

### Precomputations.
    # Calculate the ratio of not fetching any accounts (with certain type)
    # over certain interval of time.
  - record: ratio:tink_no_checking_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="CHECKING"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)
  - record: ratio:tink_no_savings_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="SAVINGS"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_creditcards_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="CREDIT_CARD"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_investment_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="INVESTMENT"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

  - record: ratio:tink_no_loan_accounts_fetched:delta1h
    expr: sum(increase(tink_no_accounts_fetched_total {type="LOAN"} [1h])) BY (provider)
        / sum(increase(tink_accounts_refresh_total[1h])) BY (provider)

    # Calculate the the ration of provider errors (without authentication errors).
  - record: ratio:tink_provider_errors:delta60m
    expr: 100 * ((sum(increase(tink_temporary_errors_total[1h])) BY (provider)) /
      (sum(increase(tink_executions_total[1h])) BY (provider)))

# Payments SE market dashboard
  - record: sum:tink_transfers_in_sweden:delta15m
    expr: sum(increase(tink_agent_transfer_total{market="SE"}[15m])) or on() vector(0)

  - record: sum:tink_transfers_in_sweden:delta12h
    expr: sum(increase(tink_agent_transfer_total{market="SE"}[12h])) or on() vector(0)

  - record: sum:tink_successful_transfers_in_sweden:delta15m
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="completed"}[15m])) or on() vector(0)

  - record: sum:tink_successful_transfers_in_sweden:delta12h
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="completed"}[12h])) or on() vector(0)

  - record: sum:tink_failed_transfers_in_sweden:delta15m
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="failed"}[15m])) or on() vector(0)

  - record: sum:tink_failed_transfers_in_sweden:delta12h
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="failed"}[12h])) or on() vector(0)

  - record: sum:tink_cancelled_transfers_in_sweden:delta15m
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="cancelled"}[15m])) or on() vector(0)

  - record: sum:tink_cancelled_transfers_in_sweden:delta12h
    expr: sum(increase(tink_agent_transfer_total{market="SE", outcome="cancelled"}[12h])) or on() vector(0)

  # Precompute realtime banking metrics
  - record: ratio:tink_aggregation_market_success:delta5m
    expr: sum(increase(tink_aggregation_successful_market_total[5m])) by (market)
        / sum(increase(tink_aggregation_total_market_total[5m])) by (market) > 0

  - record: ratio:tink_aggregation_operation_success:delta5m
    expr: sum(increase(tink_aggregation_successful_operations_total[5m])) by (operation)
       / sum(increase(tink_aggregation_total_operations_total[5m])) by (operation) > 0

  - record: ratio:tink_aggregation_market_operation_success:delta5m
    expr: sum(increase(tink_aggregation_successful_market_operations_total[5m])) by (operation, market)
      / sum(increase(tink_aggregation_total_market_operations_total[5m])) by (operation, market) > 0

  # Precompute statistics
  - record: statistics:tink_aggregation_market_success:delta5m:avg1w
    expr: avg_over_time((ratio:tink_aggregation_market_success:delta5m > 0)[1w:])

  - record: statistics:tink_aggregation_market_success:delta5m:stddev1w
    expr: stddev_over_time((ratio:tink_aggregation_market_success:delta5m > 0)[1w:])

  - record: statistics:tink_aggregation_operation_success:delta5m:avg1w
    expr: avg_over_time((ratio:tink_aggregation_operation_success:delta5m > 0)[1w:])

  - record: statistics:tink_aggregation_operation_success:delta5m:stddev1w
    expr: stddev_over_time((ratio:tink_aggregation_operation_success:delta5m > 0)[1w:])

  - record: statistics:tink_aggregation_market_operation_success:delta5m:avg1w
    expr: avg_over_time((ratio:tink_aggregation_market_operation_success:delta5m > 0)[1w:])

  - record: statistics:tink_aggregation_market_operation_success:delta5m:stddev1w
    expr: stddev_over_time((ratio:tink_aggregation_market_operation_success:delta5m > 0)[1w:])

  {{- if eq .Values.Environment "production" }}
  - alert: TransferFailedOutcomeThresholdIsPassedForSwedenTier2Banks
    expr: sum by (provider, outcome) (increase(tink_agent_transfer_total{market="SE", provider!~".*(nordea|seb|swedbank|handelsbanken).*", outcome="failed"}[1h])) >= 5
    labels:
      severity: urgent
      who: payments
      priority: P4
    annotations:
      description: Check overall trend for this provider to assess the impact. https://grafana.global-production.tink.network/d/NMhMIXRGz/se-trends-from-aggregation-service-pov?orgId=1&from=now-12h&to=now
      summary: Threshold exceed for ( <{ $labels.provider }> ) for transfers with outcome ( <{ $labels.outcome }> ).

  - alert: TransferFailedOutcomeThresholdIsPassedForSwedenTier1Banks
    expr: sum by (provider, outcome) (increase(tink_agent_transfer_total{market="SE", provider=~".*(nordea|seb|swedbank|handelsbanken).*", outcome="failed"}[1h])) >= 5
    labels:
      severity: urgent
      who: payments
      priority: P3
    annotations:
      description: Check overall trend for this provider to assess the impact. https://grafana.global-production.tink.network/d/NMhMIXRGz/se-trends-from-aggregation-service-pov?orgId=1&from=now-12h&to=now
      summary: Threshold exceed for ( <{ $labels.provider }> ) for transfers with outcome ( <{ $labels.outcome }> ).
  {{- end }}
