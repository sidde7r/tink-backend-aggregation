version: '2.1'
services:
  bazels3cache:
    image: "gcr.io/tink-containers/bazels3cache:latest"
    environment:
      - S3_BUCKET=tink-bazel-cache-build-production
  app:
    image: "gcr.io/tink-containers/bazel:3.7.2.11"
    working_dir: /tink-backend-aggregation
    links:
      - bazels3cache
    volumes:
      - "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}"
      - ..:/tink-backend-aggregation
      - /var/lib/buildkite-agent/.cache/bazel:/root/.cache/bazel
      - /usr/bin/buildkite-agent:/usr/bin/buildkite-agent:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /bazel-remote-cache:/cache
    environment:
      - SSH_AUTH_SOCK
      - VERSION
      - BUILDKITE_JOB_ID
      - BUILDKITE_BUILD_ID
      - BUILDKITE_BRANCH
      - BUILDKITE_AGENT_ACCESS_TOKEN
      - TINK_REPO_UPLOAD_ACCESS_KEY_ID
      - TINK_REPO_UPLOAD_SECRET_ACCESS_KEY
      - GOOGLE_CLOUD_ACCOUNT_JSON
      - USER=root
