version: '2.1'
services:
  app:
    command: .buildkite/run-system-tests.sh
    image: "gcr.io/tink-containers/bazel:3.0.0"
    working_dir: /tink-backend
    volumes:
      - "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}"
      - ..:/tink-backend
      - /usr/bin/buildkite-agent:/usr/bin/buildkite-agent:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /bazel-remote-cache:/cache
    environment:
      - SSH_AUTH_SOCK
      - VERSION
      - BUILDKITE_JOB_ID
      - BUILDKITE_BUILD_ID
      - BUILDKITE_BRANCH
      - BUILDKITE_AGENT_ACCESS_TOKEN
      - TINK_REPO_UPLOAD_ACCESS_KEY_ID
      - TINK_REPO_UPLOAD_SECRET_ACCESS_KEY
      - GOOGLE_CLOUD_ACCOUNT_JSON
      - CODECOV_TOKEN
      - USER=root
    depends_on:
      - aggregation_service
      - fake_aggregation_controller
    networks:
      - mynetwork
  aggregation_service:
    command: .buildkite/run-aggregation-decoupled.sh
    image: "gcr.io/tink-containers/bazel:3.0.0"
    working_dir: /tink-backend
    volumes:
      - "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}"
      - ..:/tink-backend
      - /usr/bin/buildkite-agent:/usr/bin/buildkite-agent:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /bazel-remote-cache:/cache
    environment:
      - SSH_AUTH_SOCK
      - VERSION
      - BUILDKITE_JOB_ID
      - BUILDKITE_BUILD_ID
      - BUILDKITE_BRANCH
      - BUILDKITE_AGENT_ACCESS_TOKEN
      - TINK_REPO_UPLOAD_ACCESS_KEY_ID
      - TINK_REPO_UPLOAD_SECRET_ACCESS_KEY
      - GOOGLE_CLOUD_ACCOUNT_JSON
      - CODECOV_TOKEN
      - USER=root
      - AGGREGATION_CONTROLLER_SOCKET=fake_aggregation_controller:8080
    ports:
      - "9095:9095"
    expose:
      - 9095
    networks:
      mynetwork:
        aliases:
          - aggregation_service
  fake_aggregation_controller:
    command: .buildkite/run-fake-aggregation-controller.sh
    image: "gcr.io/tink-containers/bazel:3.0.0"
    working_dir: /tink-backend
    volumes:
      - "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}"
      - ..:/tink-backend
      - /usr/bin/buildkite-agent:/usr/bin/buildkite-agent:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - /bazel-remote-cache:/cache
    environment:
      - SSH_AUTH_SOCK
      - VERSION
      - BUILDKITE_JOB_ID
      - BUILDKITE_BUILD_ID
      - BUILDKITE_BRANCH
      - BUILDKITE_AGENT_ACCESS_TOKEN
      - TINK_REPO_UPLOAD_ACCESS_KEY_ID
      - TINK_REPO_UPLOAD_SECRET_ACCESS_KEY
      - GOOGLE_CLOUD_ACCOUNT_JSON
      - CODECOV_TOKEN
      - USER=root
    ports:
      - "8080:8080"
    expose:
      - 8080
    networks:
      mynetwork:
        aliases:
          - fake_aggregation_controller
networks:
  mynetwork:
    driver: "bridge"
